<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>klImageCore: SlideMacroFns.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>SlideMacroFns.cpp</h1>  </div>
</div>
<div class="contents">
<a href="_slide_macro_fns_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*******************************</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) &lt;2007&gt;, &lt;Bruce Campbell&gt; All rights reserved. Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met: 1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  </span>
<a name="l00003"></a>00003 <span class="comment"> * Bruce B Campbell 11 30 2012  *</span>
<a name="l00004"></a>00004 <span class="comment"> ********************************/</span>
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="preprocessor">#include &quot;<a class="code" href="kl__image__processing__functors_8h.html">kl_image_processing_functors.h</a>&quot;</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="comment">//ppm_helper include</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;<a class="code" href="ppm__helper_8h.html">ppm_helper.h</a>&quot;</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="comment">//It simply rotates the greyscale WSI from the Hamamatsu.</span>
<a name="l00012"></a><a class="code" href="_slide_macro_fns_8cpp.html#a1ece55f9334901bfa324e502fdb54c80">00012</a> <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">bool</span> <a class="code" href="_slide_macro_fns_8cpp.html#a1ece55f9334901bfa324e502fdb54c80">tRotate</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* macro,<span class="keyword">const</span> <span class="keywordtype">char</span>* thumbnail,<span class="keyword">const</span> <span class="keywordtype">char</span>* ofile)
<a name="l00013"></a>00013 {
<a name="l00014"></a>00014     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> thumbwidth=0;
<a name="l00015"></a>00015     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> thumbheight=0;
<a name="l00016"></a>00016     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> thumbbands=0;
<a name="l00017"></a>00017 
<a name="l00018"></a>00018     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> thumbRBP;
<a name="l00019"></a>00019     <span class="keywordflow">if</span>( <a class="code" href="kl__ppm__image__io_8cpp.html#a3453a753c60d966d35724298d6118a7c">query_ppm</a> (thumbnail, thumbwidth, thumbheight,thumbbands))
<a name="l00020"></a>00020     {
<a name="l00021"></a>00021         thumbRBP=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a>(thumbwidth,thumbheight, thumbbands);
<a name="l00022"></a>00022         <a class="code" href="kl__ppm__image__io_8cpp.html#a4e631bab8c488b3cdb27e6829a66a8a7">read_ppm</a> (thumbnail, thumbwidth, thumbheight, thumbbands, thumbRBP-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a0b9e8748d6febe81c5803003a38c9b9a">buffer</a>());
<a name="l00023"></a>00023     }
<a name="l00024"></a>00024     <span class="keywordflow">else</span>
<a name="l00025"></a>00025     {
<a name="l00026"></a>00026         <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Bad input file for thumbnail image in MacroThumb_9_0(char* macro, char* thumb,char* ofile)&quot;</span>;
<a name="l00027"></a>00027     }
<a name="l00028"></a>00028 
<a name="l00029"></a>00029     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> macrowidth=0;
<a name="l00030"></a>00030     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> macroheight=0;
<a name="l00031"></a>00031     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> macrobands=0;
<a name="l00032"></a>00032     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> macroRBP;
<a name="l00033"></a>00033     <span class="keywordflow">if</span>( <a class="code" href="kl__ppm__image__io_8cpp.html#a3453a753c60d966d35724298d6118a7c">query_ppm</a> (macro, macrowidth, macroheight,macrobands))
<a name="l00034"></a>00034     {
<a name="l00035"></a>00035         macroRBP=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a>(macrowidth,macroheight, macrobands);
<a name="l00036"></a>00036         <a class="code" href="kl__ppm__image__io_8cpp.html#a4e631bab8c488b3cdb27e6829a66a8a7">read_ppm</a> (macro, macrowidth, macroheight, macrobands, macroRBP-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a0b9e8748d6febe81c5803003a38c9b9a">buffer</a>());
<a name="l00037"></a>00037     }
<a name="l00038"></a>00038     <span class="keywordflow">else</span>
<a name="l00039"></a>00039     {
<a name="l00040"></a>00040         <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Bad imput file for label image in MacroThumb_9_0(char* macro, char* thumb,char* ofile)&quot;</span>;
<a name="l00041"></a>00041 
<a name="l00042"></a>00042     }   
<a name="l00043"></a>00043     <span class="keywordflow">if</span>(macrobands!=thumbbands)
<a name="l00044"></a>00044     {
<a name="l00045"></a>00045         <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Bad imput file for image in MacroThumb_9_0(char* macro, char* thumb,char* ofile)&quot;</span>;
<a name="l00046"></a>00046     }
<a name="l00047"></a>00047     <span class="comment">//write_ppm (&quot;MACRO_THUMB_macro_INPUT.ppm&quot;, macroRBP-&gt;width(), macroRBP-&gt;height(),macroRBP-&gt;buffer());</span>
<a name="l00048"></a>00048     <span class="comment">//write_ppm (&quot;MACRO_THUMB_thumb_INPUT.ppm&quot;, thumbRBP-&gt;width(), thumbRBP-&gt;height(),thumbRBP-&gt;buffer());</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050     <span class="comment">//double angle=-90;</span>
<a name="l00051"></a>00051     <span class="comment">//int interpolate=IPPI_INTER_NN;</span>
<a name="l00052"></a>00052     <span class="comment">//klRotateFunctor&lt;unsigned char&gt; klro_u8(macroRBP, angle, interpolate);</span>
<a name="l00053"></a>00053     <span class="comment">//klRasterBufferPointer macro_rotated =klro_u8();</span>
<a name="l00054"></a>00054     
<a name="l00055"></a>00055     <span class="keywordtype">size_t</span> outbands=macroRBP-&gt;numBands();
<a name="l00056"></a>00056     <span class="keywordtype">size_t</span> outwidth =macroRBP-&gt;width();
<a name="l00057"></a>00057     <span class="keywordtype">size_t</span> outheight=macroRBP-&gt;height(); 
<a name="l00058"></a>00058     <span class="keywordtype">size_t</span> outbandStride=macroRBP-&gt;bandStride();
<a name="l00059"></a>00059     <span class="keywordtype">size_t</span> outxStride =macroRBP-&gt;xStride();
<a name="l00060"></a>00060     <span class="keywordtype">size_t</span> outyStride= macroRBP-&gt;yStride();
<a name="l00061"></a>00061         
<a name="l00062"></a>00062     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* rotated_macro = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[outheight*outwidth*outbands];
<a name="l00063"></a>00063     
<a name="l00064"></a>00064     <span class="keywordtype">int</span> i=0;
<a name="l00065"></a>00065     <span class="keywordtype">int</span> j=0;
<a name="l00066"></a>00066     <span class="keywordtype">int</span> k=0;
<a name="l00067"></a>00067     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pix_stride=3;
<a name="l00068"></a>00068     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> width=macroRBP-&gt;width();
<a name="l00069"></a>00069     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> height =macroRBP-&gt;height();
<a name="l00070"></a>00070     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* buf=macroRBP-&gt;buffer();
<a name="l00071"></a>00071     <span class="keywordflow">for</span>(i=0;i&lt;width;i++)
<a name="l00072"></a>00072     {
<a name="l00073"></a>00073         <span class="keywordflow">for</span>(j=height-1, k=0;j&gt;=0;j--, k++)
<a name="l00074"></a>00074         {
<a name="l00075"></a>00075             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> R=*(buf+j*outyStride +i*outxStride +0);
<a name="l00076"></a>00076             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> G=*(buf+j*outyStride +i*outxStride +1);
<a name="l00077"></a>00077             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> B=*(buf+j*outyStride +i*outxStride +2);
<a name="l00078"></a>00078 
<a name="l00079"></a>00079             *(rotated_macro+ i*height*pix_stride +k*pix_stride +0)=R;
<a name="l00080"></a>00080             *(rotated_macro+ i*height*pix_stride +k*pix_stride +1)=G;
<a name="l00081"></a>00081             *(rotated_macro+ i*height*pix_stride +k*pix_stride +2)=B;
<a name="l00082"></a>00082         }
<a name="l00083"></a>00083     }
<a name="l00084"></a>00084     <a class="code" href="kl__ppm__image__io_8cpp.html#abd4e33d1b3a2a25e1a64f8a52a101150">write_ppm</a> (ofile, outheight, outwidth,rotated_macro);
<a name="l00085"></a>00085     <span class="comment">//write_ppm (ofile,  macro_rotated-&gt;width(), macro_rotated-&gt;height(),macro_rotated-&gt;buffer());</span>
<a name="l00086"></a>00086     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00087"></a>00087 }
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="comment">//This is called if (!isLabel &amp;&amp; isMacro &amp;&amp; isThumb) and we want to make a color tumbnail.  We assume the label is in the top part of the WSI Image.</span>
<a name="l00090"></a>00090 <span class="comment">//For Hamamatsu, this is the case. </span>
<a name="l00091"></a><a class="code" href="_slide_macro_fns_8cpp.html#a8d026506777c3b1c2bd653d9d414f1a5">00091</a> <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">bool</span> <a class="code" href="_slide_macro_fns_8cpp.html#a8d026506777c3b1c2bd653d9d414f1a5">tMacroThumb</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* macro,<span class="keyword">const</span> <span class="keywordtype">char</span>* thumbnail,<span class="keyword">const</span> <span class="keywordtype">char</span>* ofile)
<a name="l00092"></a>00092 {
<a name="l00093"></a>00093     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> thumbwidth=0;
<a name="l00094"></a>00094     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> thumbheight=0;
<a name="l00095"></a>00095     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> thumbbands=0;
<a name="l00096"></a>00096 
<a name="l00097"></a>00097     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> thumbRBP;
<a name="l00098"></a>00098     <span class="keywordflow">if</span>( <a class="code" href="kl__ppm__image__io_8cpp.html#a3453a753c60d966d35724298d6118a7c">query_ppm</a> (thumbnail, thumbwidth, thumbheight,thumbbands))
<a name="l00099"></a>00099     {
<a name="l00100"></a>00100         thumbRBP=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a>(thumbwidth,thumbheight, thumbbands);
<a name="l00101"></a>00101         <a class="code" href="kl__ppm__image__io_8cpp.html#a4e631bab8c488b3cdb27e6829a66a8a7">read_ppm</a> (thumbnail, thumbwidth, thumbheight, thumbbands, thumbRBP-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a0b9e8748d6febe81c5803003a38c9b9a">buffer</a>());
<a name="l00102"></a>00102     }
<a name="l00103"></a>00103     <span class="keywordflow">else</span>
<a name="l00104"></a>00104     {
<a name="l00105"></a>00105         <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Bad input file for thumbnail image in MacroThumb_9_0(char* macro, char* thumb,char* ofile)&quot;</span>;
<a name="l00106"></a>00106     }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> macrowidth=0;
<a name="l00109"></a>00109     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> macroheight=0;
<a name="l00110"></a>00110     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> macrobands=0;
<a name="l00111"></a>00111     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> macroRBP;
<a name="l00112"></a>00112     <span class="keywordflow">if</span>( <a class="code" href="kl__ppm__image__io_8cpp.html#a3453a753c60d966d35724298d6118a7c">query_ppm</a> (macro, macrowidth, macroheight,macrobands))
<a name="l00113"></a>00113     {
<a name="l00114"></a>00114         macroRBP=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a>(macrowidth,macroheight, macrobands);
<a name="l00115"></a>00115         <a class="code" href="kl__ppm__image__io_8cpp.html#a4e631bab8c488b3cdb27e6829a66a8a7">read_ppm</a> (macro, macrowidth, macroheight, macrobands, macroRBP-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a0b9e8748d6febe81c5803003a38c9b9a">buffer</a>());
<a name="l00116"></a>00116     }
<a name="l00117"></a>00117     <span class="keywordflow">else</span>
<a name="l00118"></a>00118     {
<a name="l00119"></a>00119         <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Bad imput file for label image in MacroThumb_9_0(char* macro, char* thumb,char* ofile)&quot;</span>;
<a name="l00120"></a>00120 
<a name="l00121"></a>00121     }   
<a name="l00122"></a>00122     <span class="keywordflow">if</span>(macrobands!=thumbbands)
<a name="l00123"></a>00123     {
<a name="l00124"></a>00124         <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Bad imput file for image in MacroThumb_9_0(char* macro, char* thumb,char* ofile)&quot;</span>;
<a name="l00125"></a>00125     }
<a name="l00126"></a>00126     <span class="comment">//write_ppm (&quot;MACRO_THUMB_macro_INPUT.ppm&quot;, macroRBP-&gt;width(), macroRBP-&gt;height(),macroRBP-&gt;buffer());</span>
<a name="l00127"></a>00127     <span class="comment">//write_ppm (&quot;MACRO_THUMB_thumb_INPUT.ppm&quot;, thumbRBP-&gt;width(), thumbRBP-&gt;height(),thumbRBP-&gt;buffer());</span>
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     <span class="keywordtype">double</span> scaleFactor=0.31450827653359298928919182083739;<span class="comment">//</span>
<a name="l00130"></a>00130     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lwn=macrowidth * scaleFactor;
<a name="l00131"></a>00131     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> labelRBP=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a>(lwn,macroRBP-&gt;height() , macroRBP-&gt;numBands());
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     <a class="code" href="classkl_rect.html">klRect</a> iRoi1(0,0,labelRBP-&gt;width(),labelRBP-&gt;height() );
<a name="l00134"></a>00134     <a class="code" href="classkl_rect.html">klRect</a> oRoi1(0,0,labelRBP-&gt;width(),labelRBP-&gt;height() );
<a name="l00135"></a>00135 
<a name="l00136"></a>00136     <a class="code" href="classkl_copy_r_o_i_functor.html">klCopyROIFunctor&lt;unsigned char&gt;</a> kl_cf_u8_step1(labelRBP ,  macroRBP,  iRoi1, oRoi1);
<a name="l00137"></a>00137     kl_cf_u8_step1();
<a name="l00138"></a>00138     <span class="comment">//write_ppm (&quot;MACRO_THUMB_LABELEXTRACT_1.ppm&quot;, labelRBP-&gt;width(), labelRBP-&gt;height(),labelRBP-&gt;buffer());</span>
<a name="l00139"></a>00139 
<a name="l00140"></a>00140     scaleFactor = (double) labelRBP-&gt;height() / (double)thumbRBP-&gt;width()   ;
<a name="l00141"></a>00141     
<a name="l00142"></a>00142     <span class="keywordtype">double</span> xFactor=scaleFactor;     
<a name="l00143"></a>00143     <span class="keywordtype">double</span> yFactor=scaleFactor;
<a name="l00144"></a>00144     <span class="keywordtype">int</span> interpolate=IPPI_INTER_NN;
<a name="l00145"></a>00145     <a class="code" href="classkl_resize_functor.html">klResizeFunctor&lt;unsigned char&gt;</a> klrs_thumb_u8(thumbRBP, xFactor, yFactor, interpolate);
<a name="l00146"></a>00146     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> thumb_resampled =klrs_thumb_u8();
<a name="l00147"></a>00147     <span class="comment">//write_ppm (&quot;MACRO_THUMB_RESAMPLED_THUMB_2.ppm&quot;, thumb_resampled-&gt;width(), thumb_resampled-&gt;height(),thumb_resampled-&gt;buffer());</span>
<a name="l00148"></a>00148 
<a name="l00149"></a>00149     <span class="keywordtype">double</span> angle=90;
<a name="l00150"></a>00150         
<a name="l00151"></a>00151     <a class="code" href="classkl_rotate_functor.html">klRotateFunctor&lt;unsigned char&gt;</a> klro_u8(thumb_resampled, angle, interpolate);
<a name="l00152"></a>00152     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> thumb_rotated =klro_u8();
<a name="l00153"></a>00153     <span class="comment">//write_ppm (&quot;MACRO_THUMB_ROTATED_3.ppm&quot;, thumb_rotated-&gt;width(), thumb_rotated-&gt;height(),thumb_rotated-&gt;buffer());</span>
<a name="l00154"></a>00154 
<a name="l00155"></a>00155     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> fmacroRBP=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a>(labelRBP-&gt;width()+thumb_resampled-&gt;height() ,labelRBP-&gt;height() , labelRBP-&gt;numBands());
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     <span class="comment">//Do a memset one the RBP</span>
<a name="l00158"></a>00158     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* bufMem=fmacroRBP-&gt;buffer();
<a name="l00159"></a>00159     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bufSize=fmacroRBP-&gt;yStride()*fmacroRBP-&gt;height();
<a name="l00160"></a>00160     memset(bufMem,128,bufSize);
<a name="l00161"></a>00161     <span class="comment">//write_ppm (&quot;MACRO_THUMB_fMacroRBP_Memset_4.ppm&quot;, fmacroRBP-&gt;width(), fmacroRBP-&gt;height(),fmacroRBP-&gt;buffer());</span>
<a name="l00162"></a>00162 
<a name="l00163"></a>00163     <a class="code" href="classkl_rect.html">klRect</a> iRoi2(0,0,labelRBP-&gt;width(),labelRBP-&gt;height() );
<a name="l00164"></a>00164     <a class="code" href="classkl_rect.html">klRect</a> oRoi2(0,0,labelRBP-&gt;width(),labelRBP-&gt;height() );
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     <a class="code" href="classkl_copy_r_o_i_functor.html">klCopyROIFunctor&lt;unsigned char&gt;</a> kl_cf_u8_step2( fmacroRBP,labelRBP ,  iRoi2, oRoi2);
<a name="l00167"></a>00167     kl_cf_u8_step2();
<a name="l00168"></a>00168     <span class="comment">//write_ppm (&quot;MACRO_THUMB_copyROI_LABEINTOMCARO_5.ppm&quot;, fmacroRBP-&gt;width(), fmacroRBP-&gt;height(),fmacroRBP-&gt;buffer());</span>
<a name="l00169"></a>00169 
<a name="l00170"></a>00170     <a class="code" href="classkl_rect.html">klRect</a> iRoi3(0,(thumb_rotated-&gt;height() - fmacroRBP-&gt;height())/2.0,thumb_rotated-&gt;width(),labelRBP-&gt;height() );
<a name="l00171"></a>00171     <a class="code" href="classkl_rect.html">klRect</a> oRoi3(labelRBP-&gt;width(),0,thumb_rotated-&gt;width(),labelRBP-&gt;height() );
<a name="l00172"></a>00172 
<a name="l00173"></a>00173     <a class="code" href="classkl_copy_r_o_i_functor.html">klCopyROIFunctor&lt;unsigned char&gt;</a> kl_cf_u8_step3(fmacroRBP  ,thumb_rotated ,oRoi3 ,iRoi3 );
<a name="l00174"></a>00174     kl_cf_u8_step3();
<a name="l00175"></a>00175     <span class="comment">//write_ppm (&quot;MACRO_THUMB_FINAL_6.ppm&quot;,fmacroRBP);</span>
<a name="l00176"></a>00176 
<a name="l00177"></a>00177     <a class="code" href="kl__ppm__image__io_8cpp.html#abd4e33d1b3a2a25e1a64f8a52a101150">write_ppm</a> (ofile,  fmacroRBP-&gt;width(), fmacroRBP-&gt;height(),fmacroRBP-&gt;buffer());
<a name="l00178"></a>00178     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00179"></a>00179 }
<a name="l00180"></a>00180 
<a name="l00181"></a>00181 <span class="comment">//This is called if(isThumb &amp;&amp; isLabel) which is the case for older Aperio images.  The thnumbnail indicates the image data</span>
<a name="l00182"></a>00182 <span class="comment">//actually in the file.  There is no WSI in this case.  These types of images also come from exports from the Aperio SCanSCope software.</span>
<a name="l00183"></a><a class="code" href="_slide_macro_fns_8cpp.html#a83d67361d14de5f3f48b95432c0f57e3">00183</a> <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">bool</span> <a class="code" href="_slide_macro_fns_8cpp.html#a83d67361d14de5f3f48b95432c0f57e3">tMacro</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* thumbnail,<span class="keyword">const</span> <span class="keywordtype">char</span>* label,<span class="keyword">const</span> <span class="keywordtype">char</span>* ofile)
<a name="l00184"></a>00184 {
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> thumbwidth=0;
<a name="l00187"></a>00187     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> thumbheight=0;
<a name="l00188"></a>00188     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> thumbbands=0;
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> thumbRBP;
<a name="l00191"></a>00191     <span class="keywordflow">if</span>( <a class="code" href="kl__ppm__image__io_8cpp.html#a3453a753c60d966d35724298d6118a7c">query_ppm</a> (thumbnail, thumbwidth, thumbheight,thumbbands))
<a name="l00192"></a>00192     {
<a name="l00193"></a>00193         thumbRBP=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a>(thumbwidth,thumbheight, thumbbands);
<a name="l00194"></a>00194         <a class="code" href="kl__ppm__image__io_8cpp.html#a4e631bab8c488b3cdb27e6829a66a8a7">read_ppm</a> (thumbnail, thumbwidth, thumbheight, thumbbands, thumbRBP-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a0b9e8748d6febe81c5803003a38c9b9a">buffer</a>());
<a name="l00195"></a>00195     }
<a name="l00196"></a>00196     <span class="keywordflow">else</span>
<a name="l00197"></a>00197     {
<a name="l00198"></a>00198         <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Bad input file for thumbnail image in klIPP_Make_SlideImage(char* thumbnail, char* label)&quot;</span>;
<a name="l00199"></a>00199     }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> labelwidth=0;
<a name="l00202"></a>00202     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> labelheight=0;
<a name="l00203"></a>00203     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> labelbands=0;
<a name="l00204"></a>00204     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> labelRBP;
<a name="l00205"></a>00205     <span class="keywordflow">if</span>( <a class="code" href="kl__ppm__image__io_8cpp.html#a3453a753c60d966d35724298d6118a7c">query_ppm</a> (label, labelwidth, labelheight,labelbands))
<a name="l00206"></a>00206     {
<a name="l00207"></a>00207         labelRBP=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a>(labelwidth,labelheight, labelbands);
<a name="l00208"></a>00208         <a class="code" href="kl__ppm__image__io_8cpp.html#a4e631bab8c488b3cdb27e6829a66a8a7">read_ppm</a> (label, labelwidth, labelheight, labelbands, labelRBP-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a0b9e8748d6febe81c5803003a38c9b9a">buffer</a>());
<a name="l00209"></a>00209     }
<a name="l00210"></a>00210     <span class="keywordflow">else</span>
<a name="l00211"></a>00211     {
<a name="l00212"></a>00212         <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Bad imput file for label image in klIPP_Make_SlideImage(char* thumbnail, char* label)&quot;</span>;
<a name="l00213"></a>00213 
<a name="l00214"></a>00214     }   
<a name="l00215"></a>00215     <span class="keywordflow">if</span>(labelbands!=thumbbands)
<a name="l00216"></a>00216     {
<a name="l00217"></a>00217         <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Bad imput file for image in klIPP_Make_SlideImage(char* thumbnail, char* label) - Labael and Thumb bands must be the same&quot;</span>;
<a name="l00218"></a>00218     }
<a name="l00219"></a>00219     <span class="comment">//write_ppm (&quot;MACRO_LABEL_INPUT.ppm&quot;, labelRBP-&gt;width(), labelRBP-&gt;height(),labelRBP-&gt;buffer());</span>
<a name="l00220"></a>00220     <span class="comment">//write_ppm (&quot;MACRO_THUMB_INPUT.ppm&quot;, thumbRBP-&gt;width(), thumbRBP-&gt;height(),thumbRBP-&gt;buffer());</span>
<a name="l00221"></a>00221 
<a name="l00222"></a>00222     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lhn=thumbheight;
<a name="l00223"></a>00223     <span class="keywordtype">double</span> scaleFactor=double(lhn)/(double)labelheight;
<a name="l00224"></a>00224     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lwn=labelwidth * scaleFactor;
<a name="l00225"></a>00225     <span class="keywordtype">double</span> xFactor=scaleFactor;     
<a name="l00226"></a>00226     <span class="keywordtype">double</span> yFactor=scaleFactor;
<a name="l00227"></a>00227     <span class="keywordtype">int</span> interpolate=IPPI_INTER_NN;
<a name="l00228"></a>00228     <a class="code" href="classkl_resize_functor.html">klResizeFunctor&lt;unsigned char&gt;</a> klrs_u8(labelRBP, xFactor, yFactor, interpolate);
<a name="l00229"></a>00229     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> label_resampled =klrs_u8();
<a name="l00230"></a>00230     <span class="comment">//write_ppm (&quot;MACRO_LABEL_RESAMPLED_u8_C3R.ppm&quot;, label_resampled-&gt;width(), label_resampled-&gt;height(),label_resampled-&gt;buffer());</span>
<a name="l00231"></a>00231 
<a name="l00232"></a>00232 
<a name="l00234"></a>00234     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> thumb_crop=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a>(thumbwidth-1.0/2.0*lwn -180 ,thumbheight, labelbands);
<a name="l00235"></a>00235     <a class="code" href="classkl_rect.html">klRect</a> thciRoi2(0  ,0,thumb_crop-&gt;width() ,thumb_crop-&gt;height());
<a name="l00236"></a>00236     <a class="code" href="classkl_rect.html">klRect</a> thcoRoi2(1.0/2.0* lwn,0,thumb_crop-&gt;width() ,thumb_crop-&gt;height());
<a name="l00237"></a>00237 
<a name="l00238"></a>00238     <a class="code" href="classkl_copy_r_o_i_functor.html">klCopyROIFunctor&lt;unsigned char&gt;</a> kl_thc_cf_u8_step2(thumb_crop,thumbRBP,  thciRoi2, thcoRoi2);
<a name="l00239"></a>00239     kl_thc_cf_u8_step2();
<a name="l00240"></a>00240     <span class="comment">//write_ppm (&quot;MACRO_THUMB_CROP.ppm&quot;, thumb_crop-&gt;width(), thumb_crop-&gt;height(),thumb_crop-&gt;buffer());</span>
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     <span class="comment">//Now cat the label and thumnail together</span>
<a name="l00243"></a>00243     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> label_thumb_catRBP=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a>(lwn+thumb_crop-&gt;width(),thumb_crop-&gt;height(), labelbands);
<a name="l00244"></a>00244     
<a name="l00245"></a>00245     <span class="comment">//Do a memset one the RBP</span>
<a name="l00246"></a>00246     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* bufMem=label_thumb_catRBP-&gt;buffer();
<a name="l00247"></a>00247     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bufSize=label_thumb_catRBP-&gt;yStride()*label_thumb_catRBP-&gt;height();
<a name="l00248"></a>00248     memset(bufMem,128,bufSize);
<a name="l00249"></a>00249 
<a name="l00250"></a>00250     <a class="code" href="classkl_rect.html">klRect</a> iRoi2(lwn,0,thumb_crop-&gt;width(),thumb_crop-&gt;height() );
<a name="l00251"></a>00251     <a class="code" href="classkl_rect.html">klRect</a> oRoi2(0,0,thumb_crop-&gt;width(),thumb_crop-&gt;height() );
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     <a class="code" href="classkl_copy_r_o_i_functor.html">klCopyROIFunctor&lt;unsigned char&gt;</a> kl_cf_u8_step2( label_thumb_catRBP,  thumb_crop,  iRoi2, oRoi2);
<a name="l00254"></a>00254     kl_cf_u8_step2();
<a name="l00255"></a>00255     <span class="comment">//write_ppm (&quot;MACRO_label_thumb_catRBP_Step1_u8_C3R.ppm&quot;, label_thumb_catRBP-&gt;width(), label_thumb_catRBP-&gt;height(),label_thumb_catRBP-&gt;buffer());</span>
<a name="l00256"></a>00256 
<a name="l00257"></a>00257     <a class="code" href="classkl_rect.html">klRect</a> iRoi(0,0,lwn,lhn);
<a name="l00258"></a>00258     <a class="code" href="classkl_rect.html">klRect</a> oRoi(0,0,lwn,lhn);
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     <a class="code" href="classkl_copy_r_o_i_functor.html">klCopyROIFunctor&lt;unsigned char&gt;</a> kl_cf_u8( label_thumb_catRBP,  label_resampled,  iRoi, oRoi);
<a name="l00261"></a>00261     kl_cf_u8();
<a name="l00262"></a>00262     <span class="comment">//write_ppm (&quot;MACRO_label_thumb_catRBP_Step2_u8_C3R.ppm&quot;, label_thumb_catRBP-&gt;width(), label_thumb_catRBP-&gt;height(),label_thumb_catRBP-&gt;buffer());</span>
<a name="l00263"></a>00263 
<a name="l00264"></a>00264     <span class="keywordtype">size_t</span> outbands=label_thumb_catRBP-&gt;numBands();
<a name="l00265"></a>00265     <span class="keywordtype">size_t</span> outwidth =label_thumb_catRBP-&gt;width();
<a name="l00266"></a>00266     <span class="keywordtype">size_t</span> outheight=label_thumb_catRBP-&gt;height(); 
<a name="l00267"></a>00267     <span class="keywordtype">size_t</span> outbandStride=label_thumb_catRBP-&gt;bandStride();
<a name="l00268"></a>00268     <span class="keywordtype">size_t</span> outxStride =label_thumb_catRBP-&gt;xStride();
<a name="l00269"></a>00269     <span class="keywordtype">size_t</span> outyStride= label_thumb_catRBP-&gt;yStride();
<a name="l00270"></a>00270         
<a name="l00271"></a>00271     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* rotated_macro = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[outheight*outwidth*outbands];
<a name="l00272"></a>00272     
<a name="l00273"></a>00273     <span class="keywordtype">int</span> i=0;
<a name="l00274"></a>00274     <span class="keywordtype">int</span> j=0;
<a name="l00275"></a>00275     <span class="keywordtype">int</span> k=0;
<a name="l00276"></a>00276     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pix_stride=3;
<a name="l00277"></a>00277     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> width=label_thumb_catRBP-&gt;width();
<a name="l00278"></a>00278     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> height =label_thumb_catRBP-&gt;height();
<a name="l00279"></a>00279     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* buf=label_thumb_catRBP-&gt;buffer();
<a name="l00280"></a>00280     <span class="keywordflow">for</span>(i=0;i&lt;width;i++)
<a name="l00281"></a>00281     {
<a name="l00282"></a>00282         <span class="keywordflow">for</span>(j=height-1, k=0;j&gt;=0;j--, k++)
<a name="l00283"></a>00283         {
<a name="l00284"></a>00284             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* iPtr = buf+j*outyStride +i*outxStride;
<a name="l00285"></a>00285 
<a name="l00286"></a>00286             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> R=*(iPtr  +0);
<a name="l00287"></a>00287             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> G=*(iPtr  +1);
<a name="l00288"></a>00288             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> B=*(iPtr  +2);
<a name="l00289"></a>00289 
<a name="l00290"></a>00290             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* oPtr =rotated_macro+ i*height*pix_stride +k*pix_stride;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292             *(oPtr +0)=R;
<a name="l00293"></a>00293             *(oPtr +1)=G;
<a name="l00294"></a>00294             *(oPtr +2)=B;
<a name="l00295"></a>00295         }
<a name="l00296"></a>00296     }
<a name="l00297"></a>00297     
<a name="l00298"></a>00298     <a class="code" href="kl__ppm__image__io_8cpp.html#abd4e33d1b3a2a25e1a64f8a52a101150">write_ppm</a> (ofile, outheight, outwidth,rotated_macro);
<a name="l00299"></a>00299     <span class="keyword">delete</span> rotated_macro;
<a name="l00300"></a>00300     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00301"></a>00301 }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303 <span class="comment">//This is called when (isMacro &amp;&amp; isLabel).  This should be the default case.</span>
<a name="l00304"></a>00304 <span class="comment">//The label image is not included in the WSI.  This is most likely a scanner specific setting, but we assume it is not there and place </span>
<a name="l00305"></a>00305 <span class="comment">//the label provided in the proper location of the WSI.</span>
<a name="l00306"></a><a class="code" href="_slide_macro_fns_8cpp.html#a4c7127ec7ae8f017e02697664edd2158">00306</a> <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">bool</span> <a class="code" href="_slide_macro_fns_8cpp.html#a4c7127ec7ae8f017e02697664edd2158">tSlideImage</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* thumbnail,<span class="keyword">const</span>  <span class="keywordtype">char</span>* label,<span class="keyword">const</span> <span class="keywordtype">char</span>* ofile)
<a name="l00307"></a>00307 {
<a name="l00308"></a>00308 
<a name="l00309"></a>00309     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> thumbwidth=0;
<a name="l00310"></a>00310     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> thumbheight=0;
<a name="l00311"></a>00311     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> thumbbands=0;
<a name="l00312"></a>00312     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> thumbRBP;
<a name="l00313"></a>00313     <span class="keywordflow">if</span>( <a class="code" href="kl__ppm__image__io_8cpp.html#a3453a753c60d966d35724298d6118a7c">query_ppm</a> (thumbnail, thumbwidth, thumbheight,thumbbands))
<a name="l00314"></a>00314     {
<a name="l00315"></a>00315         thumbRBP=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a>(thumbwidth,thumbheight, thumbbands);
<a name="l00316"></a>00316         <a class="code" href="kl__ppm__image__io_8cpp.html#a4e631bab8c488b3cdb27e6829a66a8a7">read_ppm</a> (thumbnail, thumbwidth, thumbheight, thumbbands, thumbRBP-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a0b9e8748d6febe81c5803003a38c9b9a">buffer</a>());
<a name="l00317"></a>00317     }
<a name="l00318"></a>00318     <span class="keywordflow">else</span>
<a name="l00319"></a>00319     {
<a name="l00320"></a>00320         <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Bad imput file for thumbnail image in klIPP_Make_SlideImage(char* thumbnail, char* label)&quot;</span>;
<a name="l00321"></a>00321     }
<a name="l00322"></a>00322 
<a name="l00323"></a>00323     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> labelwidth=0;
<a name="l00324"></a>00324     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> labelheight=0;
<a name="l00325"></a>00325     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> labelbands=0;
<a name="l00326"></a>00326     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> labelRBP;
<a name="l00327"></a>00327     <span class="keywordflow">if</span>( <a class="code" href="kl__ppm__image__io_8cpp.html#a3453a753c60d966d35724298d6118a7c">query_ppm</a> (label, labelwidth, labelheight,labelbands))
<a name="l00328"></a>00328     {
<a name="l00329"></a>00329         labelRBP=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a>(labelwidth,labelheight, labelbands);
<a name="l00330"></a>00330         <a class="code" href="kl__ppm__image__io_8cpp.html#a4e631bab8c488b3cdb27e6829a66a8a7">read_ppm</a> (label, labelwidth, labelheight, labelbands, labelRBP-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a0b9e8748d6febe81c5803003a38c9b9a">buffer</a>());
<a name="l00331"></a>00331     }
<a name="l00332"></a>00332     <span class="keywordflow">else</span>
<a name="l00333"></a>00333     {
<a name="l00334"></a>00334         <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Bad imput file for label image in klIPP_Make_SlideImage(char* thumbnail, char* label)&quot;</span>;
<a name="l00335"></a>00335 
<a name="l00336"></a>00336     }   
<a name="l00337"></a>00337     <span class="keywordflow">if</span>(labelbands!=thumbbands)
<a name="l00338"></a>00338     {
<a name="l00339"></a>00339         <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Bad imput file for image in klIPP_Make_SlideImage(char* thumbnail, char* label) - Labael and Thumb bands must be the same&quot;</span>;
<a name="l00340"></a>00340     }
<a name="l00341"></a>00341     <a class="code" href="kl__ppm__image__io_8cpp.html#abd4e33d1b3a2a25e1a64f8a52a101150">write_ppm</a> (<span class="stringliteral">&quot;MSI_LABEL_INPUT.ppm&quot;</span>, labelRBP-&gt;width(), labelRBP-&gt;height(),labelRBP-&gt;buffer());
<a name="l00342"></a>00342     <a class="code" href="kl__ppm__image__io_8cpp.html#abd4e33d1b3a2a25e1a64f8a52a101150">write_ppm</a> (<span class="stringliteral">&quot;MSI_THUMB_INPUT.ppm&quot;</span>, thumbRBP-&gt;width(), thumbRBP-&gt;height(),thumbRBP-&gt;buffer());
<a name="l00343"></a>00343 
<a name="l00344"></a>00344     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lhn=thumbheight;
<a name="l00345"></a>00345     <span class="keywordtype">double</span> scaleFactor=double(lhn)/(double)labelheight;
<a name="l00346"></a>00346     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lwn=labelwidth * scaleFactor;
<a name="l00347"></a>00347     <span class="keywordtype">double</span> xFactor=scaleFactor;     
<a name="l00348"></a>00348     <span class="keywordtype">double</span> yFactor=scaleFactor;
<a name="l00349"></a>00349     <span class="keywordtype">int</span> interpolate=IPPI_INTER_NN;
<a name="l00350"></a>00350     <a class="code" href="classkl_resize_functor.html">klResizeFunctor&lt;unsigned char&gt;</a> klrs_u8(labelRBP, xFactor, yFactor, interpolate);
<a name="l00351"></a>00351     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> label_resampled =klrs_u8();
<a name="l00352"></a>00352     <span class="comment">//write_ppm (&quot;MSI_LABEL_RESAMPLED_u8_C3R.ppm&quot;, label_resampled-&gt;width(), label_resampled-&gt;height(),label_resampled-&gt;buffer());</span>
<a name="l00353"></a>00353     <span class="comment">//Now cat the label and thumnail together</span>
<a name="l00354"></a>00354     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> label_thumb_catRBP=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a>(lwn+thumbwidth,thumbheight, labelbands);
<a name="l00355"></a>00355 
<a name="l00356"></a>00356     <a class="code" href="classkl_rect.html">klRect</a> iRoi2(lwn,0,thumbwidth,thumbheight);
<a name="l00357"></a>00357     <a class="code" href="classkl_rect.html">klRect</a> oRoi2(0,0,thumbwidth,thumbheight);
<a name="l00358"></a>00358 
<a name="l00359"></a>00359     <a class="code" href="classkl_copy_r_o_i_functor.html">klCopyROIFunctor&lt;unsigned char&gt;</a> kl_cf_u8_step2( label_thumb_catRBP,  thumbRBP,  iRoi2, oRoi2);
<a name="l00360"></a>00360     kl_cf_u8_step2();
<a name="l00361"></a>00361     <span class="comment">//write_ppm (&quot;MSI_label_thumb_catRBP_Step1_u8_C3R.ppm&quot;, label_thumb_catRBP-&gt;width(), label_thumb_catRBP-&gt;height(),label_thumb_catRBP-&gt;buffer());</span>
<a name="l00362"></a>00362 
<a name="l00363"></a>00363     <a class="code" href="classkl_rect.html">klRect</a> iRoi(0,0,lwn,lhn);
<a name="l00364"></a>00364     <a class="code" href="classkl_rect.html">klRect</a> oRoi(0,0,lwn,lhn);
<a name="l00365"></a>00365 
<a name="l00366"></a>00366     <a class="code" href="classkl_copy_r_o_i_functor.html">klCopyROIFunctor&lt;unsigned char&gt;</a> kl_cf_u8( label_thumb_catRBP,  label_resampled,  iRoi, oRoi);
<a name="l00367"></a>00367     kl_cf_u8();
<a name="l00368"></a>00368     <span class="comment">//write_ppm (&quot;MSI_label_thumb_catRBP_Step2_u8_C3R.ppm&quot;, label_thumb_catRBP-&gt;width(), label_thumb_catRBP-&gt;height(),label_thumb_catRBP-&gt;buffer());</span>
<a name="l00369"></a>00369 
<a name="l00370"></a>00370     <span class="keywordtype">size_t</span> outbands=label_thumb_catRBP-&gt;numBands();
<a name="l00371"></a>00371     <span class="keywordtype">size_t</span> outwidth =label_thumb_catRBP-&gt;width();
<a name="l00372"></a>00372     <span class="keywordtype">size_t</span> outheight=label_thumb_catRBP-&gt;height(); 
<a name="l00373"></a>00373     <span class="keywordtype">size_t</span> outbandStride=label_thumb_catRBP-&gt;bandStride();
<a name="l00374"></a>00374     <span class="keywordtype">size_t</span> outxStride =label_thumb_catRBP-&gt;xStride();
<a name="l00375"></a>00375     <span class="keywordtype">size_t</span> outyStride= label_thumb_catRBP-&gt;yStride();
<a name="l00376"></a>00376         
<a name="l00377"></a>00377     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* rotated_macro = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[outheight*outwidth*outbands];
<a name="l00378"></a>00378     
<a name="l00379"></a>00379     <span class="keywordtype">int</span> i=0;
<a name="l00380"></a>00380     <span class="keywordtype">int</span> j=0;
<a name="l00381"></a>00381     <span class="keywordtype">int</span> k=0;
<a name="l00382"></a>00382     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pix_stride=3;
<a name="l00383"></a>00383     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> width=label_thumb_catRBP-&gt;width();
<a name="l00384"></a>00384     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> height =label_thumb_catRBP-&gt;height();
<a name="l00385"></a>00385     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* buf=label_thumb_catRBP-&gt;buffer();
<a name="l00386"></a>00386     <span class="keywordflow">for</span>(i=0;i&lt;width;i++)
<a name="l00387"></a>00387     {
<a name="l00388"></a>00388         <span class="keywordflow">for</span>(j=height-1, k=0;j&gt;=0;j--, k++)
<a name="l00389"></a>00389         {
<a name="l00390"></a>00390             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* iPtr = buf+j*outyStride +i*outxStride;
<a name="l00391"></a>00391             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* oPtr =rotated_macro+ i*height*pix_stride +k*pix_stride;
<a name="l00392"></a>00392 
<a name="l00393"></a>00393             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> R=*(iPtr   +0);
<a name="l00394"></a>00394             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> G=*(iPtr   +1);
<a name="l00395"></a>00395             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> B=*(iPtr   +2);
<a name="l00396"></a>00396 
<a name="l00397"></a>00397             *(oPtr +0)=R;
<a name="l00398"></a>00398             *(oPtr +1)=G;
<a name="l00399"></a>00399             *(oPtr +2)=B;
<a name="l00400"></a>00400         }
<a name="l00401"></a>00401     }
<a name="l00402"></a>00402     <a class="code" href="kl__ppm__image__io_8cpp.html#abd4e33d1b3a2a25e1a64f8a52a101150">write_ppm</a> (ofile, outheight, outwidth,rotated_macro);
<a name="l00403"></a>00403     <span class="keyword">delete</span> rotated_macro;
<a name="l00404"></a>00404     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00405"></a>00405 }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 <span class="comment">//This assumes there is a green ROI indicater in the WSI image.  We do a rough</span>
<a name="l00408"></a>00408 <span class="comment">//calculation to determine if the image data in the SVS file contains most/all of the </span>
<a name="l00409"></a>00409 <span class="comment">//tissue on the slide.</span>
<a name="l00410"></a>00410 <span class="comment">//This method is unfinished and not used in the FW release.</span>
<a name="l00411"></a><a class="code" href="_slide_macro_fns_8cpp.html#aba3656e68929f43e85c09afed29342a8">00411</a>  <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">bool</span> <a class="code" href="_slide_macro_fns_8cpp.html#aba3656e68929f43e85c09afed29342a8">tSlideImage_LT</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* thumbnail,<span class="keyword">const</span> <span class="keywordtype">char</span>* label,<span class="keyword">const</span> <span class="keywordtype">char</span>* ofile)
<a name="l00412"></a>00412 {
<a name="l00413"></a>00413 
<a name="l00414"></a>00414     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> thumbwidth=0;
<a name="l00415"></a>00415     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> thumbheight=0;
<a name="l00416"></a>00416     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> thumbbands=0;
<a name="l00417"></a>00417 
<a name="l00418"></a>00418     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> thumbRBP;
<a name="l00419"></a>00419     <span class="keywordflow">if</span>( <a class="code" href="kl__ppm__image__io_8cpp.html#a3453a753c60d966d35724298d6118a7c">query_ppm</a> (thumbnail, thumbwidth, thumbheight,thumbbands))
<a name="l00420"></a>00420     {
<a name="l00421"></a>00421         thumbRBP=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a>(thumbwidth,thumbheight, thumbbands);
<a name="l00422"></a>00422         <a class="code" href="kl__ppm__image__io_8cpp.html#a4e631bab8c488b3cdb27e6829a66a8a7">read_ppm</a> (thumbnail, thumbwidth, thumbheight, thumbbands, thumbRBP-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a0b9e8748d6febe81c5803003a38c9b9a">buffer</a>());
<a name="l00423"></a>00423     }
<a name="l00424"></a>00424     <span class="keywordflow">else</span>
<a name="l00425"></a>00425     {
<a name="l00426"></a>00426         <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Bad imput file for thumbnail image in klIPP_Make_SlideImage(char* thumbnail, char* label)&quot;</span>;
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428 
<a name="l00429"></a>00429     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> labelwidth=0;
<a name="l00430"></a>00430     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> labelheight=0;
<a name="l00431"></a>00431     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> labelbands=0;
<a name="l00432"></a>00432     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> labelRBP;
<a name="l00433"></a>00433     <span class="keywordflow">if</span>( <a class="code" href="kl__ppm__image__io_8cpp.html#a3453a753c60d966d35724298d6118a7c">query_ppm</a> (label, labelwidth, labelheight,labelbands))
<a name="l00434"></a>00434     {
<a name="l00435"></a>00435         labelRBP=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a>(labelwidth,labelheight, labelbands);
<a name="l00436"></a>00436         <a class="code" href="kl__ppm__image__io_8cpp.html#a4e631bab8c488b3cdb27e6829a66a8a7">read_ppm</a> (label, labelwidth, labelheight, labelbands, labelRBP-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a0b9e8748d6febe81c5803003a38c9b9a">buffer</a>());
<a name="l00437"></a>00437     }
<a name="l00438"></a>00438     <span class="keywordflow">else</span>
<a name="l00439"></a>00439     {
<a name="l00440"></a>00440         <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Bad imput file for label image in klIPP_Make_SlideImage(char* thumbnail, char* label)&quot;</span>;
<a name="l00441"></a>00441 
<a name="l00442"></a>00442     }   
<a name="l00443"></a>00443     <span class="keywordflow">if</span>(labelbands!=thumbbands)
<a name="l00444"></a>00444     {
<a name="l00445"></a>00445         <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Bad imput file for image in klIPP_Make_SlideImage(char* thumbnail, char* label) - Labael and Thumb bands must be the same&quot;</span>;
<a name="l00446"></a>00446     }
<a name="l00447"></a>00447     <a class="code" href="kl__ppm__image__io_8cpp.html#abd4e33d1b3a2a25e1a64f8a52a101150">write_ppm</a> (<span class="stringliteral">&quot;LT_9_0LABEL_INPUT.ppm&quot;</span>, labelRBP-&gt;width(), labelRBP-&gt;height(),labelRBP-&gt;buffer());
<a name="l00448"></a>00448 
<a name="l00449"></a>00449     <a class="code" href="kl__ppm__image__io_8cpp.html#abd4e33d1b3a2a25e1a64f8a52a101150">write_ppm</a> (<span class="stringliteral">&quot;LT_9_0THUMB_INPUT.ppm&quot;</span>, thumbRBP-&gt;width(), thumbRBP-&gt;height(),thumbRBP-&gt;buffer());
<a name="l00450"></a>00450 
<a name="l00451"></a>00451     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lhn=thumbheight;
<a name="l00452"></a>00452     <span class="keywordtype">double</span> scaleFactor=double(lhn)/(double)labelheight;
<a name="l00453"></a>00453     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lwn=labelwidth * scaleFactor;
<a name="l00454"></a>00454     <span class="keywordtype">double</span> xFactor=scaleFactor;     
<a name="l00455"></a>00455     <span class="keywordtype">double</span> yFactor=scaleFactor;
<a name="l00456"></a>00456     <span class="keywordtype">int</span> interpolate=IPPI_INTER_NN;
<a name="l00457"></a>00457     <a class="code" href="classkl_resize_functor.html">klResizeFunctor&lt;unsigned char&gt;</a> klrs_u8(labelRBP, xFactor, yFactor, interpolate);
<a name="l00458"></a>00458     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> label_resampled =klrs_u8();
<a name="l00459"></a>00459     <a class="code" href="kl__ppm__image__io_8cpp.html#abd4e33d1b3a2a25e1a64f8a52a101150">write_ppm</a> (<span class="stringliteral">&quot;LT_9_0LABEL_RESAMPLED_u8_C3R.ppm&quot;</span>, label_resampled-&gt;width(), label_resampled-&gt;height(),label_resampled-&gt;buffer());
<a name="l00460"></a>00460     <span class="comment">//Now cat the label and thumnail together</span>
<a name="l00461"></a>00461     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> label_thumb_catRBP=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a>(lwn+thumbwidth,thumbheight, labelbands);
<a name="l00462"></a>00462 
<a name="l00463"></a>00463     <a class="code" href="classkl_rect.html">klRect</a> iRoi2(lwn,0,thumbwidth,thumbheight);
<a name="l00464"></a>00464     <a class="code" href="classkl_rect.html">klRect</a> oRoi2(0,0,thumbwidth,thumbheight);
<a name="l00465"></a>00465 
<a name="l00466"></a>00466     <a class="code" href="classkl_copy_r_o_i_functor.html">klCopyROIFunctor&lt;unsigned char&gt;</a> kl_cf_u8_step2( label_thumb_catRBP,  thumbRBP,  iRoi2, oRoi2);
<a name="l00467"></a>00467     kl_cf_u8_step2();
<a name="l00468"></a>00468     <a class="code" href="kl__ppm__image__io_8cpp.html#abd4e33d1b3a2a25e1a64f8a52a101150">write_ppm</a> (<span class="stringliteral">&quot;LT_9_0label_thumb_catRBP_Step1_u8_C3R.ppm&quot;</span>, label_thumb_catRBP-&gt;width(), label_thumb_catRBP-&gt;height(),label_thumb_catRBP-&gt;buffer());
<a name="l00469"></a>00469 
<a name="l00470"></a>00470     <a class="code" href="classkl_rect.html">klRect</a> iRoi(0,0,lwn,lhn);
<a name="l00471"></a>00471     <a class="code" href="classkl_rect.html">klRect</a> oRoi(0,0,lwn,lhn);
<a name="l00472"></a>00472 
<a name="l00473"></a>00473     <a class="code" href="classkl_copy_r_o_i_functor.html">klCopyROIFunctor&lt;unsigned char&gt;</a> kl_cf_u8( label_thumb_catRBP,  label_resampled,  iRoi, oRoi);
<a name="l00474"></a>00474     kl_cf_u8();
<a name="l00475"></a>00475     <a class="code" href="kl__ppm__image__io_8cpp.html#abd4e33d1b3a2a25e1a64f8a52a101150">write_ppm</a> (<span class="stringliteral">&quot;LT_9_0label_thumb_catRBP_Step2_u8_C3R.ppm&quot;</span>, label_thumb_catRBP-&gt;width(), label_thumb_catRBP-&gt;height(),label_thumb_catRBP-&gt;buffer());
<a name="l00476"></a>00476 
<a name="l00477"></a>00477     <span class="keywordtype">size_t</span> outbands=label_thumb_catRBP-&gt;numBands();
<a name="l00478"></a>00478     <span class="keywordtype">size_t</span> outwidth =label_thumb_catRBP-&gt;width();
<a name="l00479"></a>00479     <span class="keywordtype">size_t</span> outheight=label_thumb_catRBP-&gt;height(); 
<a name="l00480"></a>00480     <span class="keywordtype">size_t</span> outbandStride=label_thumb_catRBP-&gt;bandStride();
<a name="l00481"></a>00481     <span class="keywordtype">size_t</span> outxStride =label_thumb_catRBP-&gt;xStride();
<a name="l00482"></a>00482     <span class="keywordtype">size_t</span> outyStride= label_thumb_catRBP-&gt;yStride();
<a name="l00483"></a>00483         
<a name="l00484"></a>00484     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* rotated_macro = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[outheight*outwidth*outbands];
<a name="l00485"></a>00485     
<a name="l00486"></a>00486     <span class="keywordtype">int</span> i=0;
<a name="l00487"></a>00487     <span class="keywordtype">int</span> j=0;
<a name="l00488"></a>00488     <span class="keywordtype">int</span> k=0;
<a name="l00489"></a>00489     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pix_stride=3;
<a name="l00490"></a>00490     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> width=label_thumb_catRBP-&gt;width();
<a name="l00491"></a>00491     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> height =label_thumb_catRBP-&gt;height();
<a name="l00492"></a>00492     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* buf=label_thumb_catRBP-&gt;buffer();
<a name="l00493"></a>00493     <span class="keywordflow">for</span>(i=0;i&lt;width;i++)
<a name="l00494"></a>00494     {
<a name="l00495"></a>00495         <span class="keywordflow">for</span>(j=height-1, k=0;j&gt;=0;j--, k++)
<a name="l00496"></a>00496         {
<a name="l00497"></a>00497             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> R=*(buf+j*outyStride +i*outxStride +0);
<a name="l00498"></a>00498             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> G=*(buf+j*outyStride +i*outxStride +1);
<a name="l00499"></a>00499             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> B=*(buf+j*outyStride +i*outxStride +2);
<a name="l00500"></a>00500 
<a name="l00501"></a>00501             *(rotated_macro+ i*height*pix_stride +k*pix_stride +0)=R;
<a name="l00502"></a>00502             *(rotated_macro+ i*height*pix_stride +k*pix_stride +1)=G;
<a name="l00503"></a>00503             *(rotated_macro+ i*height*pix_stride +k*pix_stride +2)=B;
<a name="l00504"></a>00504         }
<a name="l00505"></a>00505     }
<a name="l00506"></a>00506     <a class="code" href="kl__ppm__image__io_8cpp.html#abd4e33d1b3a2a25e1a64f8a52a101150">write_ppm</a> (<span class="stringliteral">&quot;LT_9_0label_thumb_catRBP_Step3_u8_C3R.ppm&quot;</span>, outheight, outwidth,rotated_macro);
<a name="l00507"></a>00507     <a class="code" href="kl__ppm__image__io_8cpp.html#abd4e33d1b3a2a25e1a64f8a52a101150">write_ppm</a> (ofile, outheight, outwidth,rotated_macro);
<a name="l00508"></a>00508     <span class="keyword">delete</span> rotated_macro;
<a name="l00509"></a>00509     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00510"></a>00510 }
<a name="l00511"></a>00511 
<a name="l00512"></a>00512 <span class="comment">//Partial Implementation</span>
<a name="l00513"></a><a class="code" href="_slide_macro_fns_8cpp.html#abe588742ace970942fb7e5ea0a7a1e1a">00513</a>  <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">double</span> <a class="code" href="_slide_macro_fns_8cpp.html#abe588742ace970942fb7e5ea0a7a1e1a">ROI_To_Tissue_Ratio</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* WSI)
<a name="l00514"></a>00514 {
<a name="l00515"></a>00515     <span class="keyword">const</span> <span class="keywordtype">char</span>* infilename=<span class="stringliteral">&quot;WSI.ppm&quot;</span> ;
<a name="l00516"></a>00516     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> inwidth=0;
<a name="l00517"></a>00517     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> inheight=0;
<a name="l00518"></a>00518     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> inbands=0;
<a name="l00519"></a>00519     <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> lsrc;
<a name="l00520"></a>00520     <span class="comment">//Test read ppm</span>
<a name="l00521"></a>00521     <span class="keywordflow">if</span>( <a class="code" href="kl__ppm__image__io_8cpp.html#a3453a753c60d966d35724298d6118a7c">query_ppm</a> (infilename, inwidth, inheight,inbands))
<a name="l00522"></a>00522     {
<a name="l00523"></a>00523         lsrc=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a>(inwidth,inheight, inbands);
<a name="l00524"></a>00524         <a class="code" href="kl__ppm__image__io_8cpp.html#a4e631bab8c488b3cdb27e6829a66a8a7">read_ppm</a> (infilename, inwidth,inheight, inbands,lsrc-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a0b9e8748d6febe81c5803003a38c9b9a">buffer</a>());
<a name="l00525"></a>00525     }
<a name="l00526"></a>00526     <span class="keywordflow">else</span>
<a name="l00527"></a>00527     {
<a name="l00528"></a>00528         <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Bad imput file in void testKLImageFunctors()&quot;</span>;
<a name="l00529"></a>00529     }
<a name="l00530"></a>00530 
<a name="l00533"></a>00533 
<a name="l00534"></a>00534     <span class="keywordtype">unsigned</span> lkernelWidthDF=3;
<a name="l00535"></a>00535     <span class="keywordtype">unsigned</span> lkernelHeightDF=3;
<a name="l00536"></a>00536     <span class="comment">//Mask values. Only pixels that correspond to nonzero </span>
<a name="l00537"></a>00537     <span class="comment">//mask values are taken into account during operation.</span>
<a name="l00538"></a>00538     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* lkernelDF = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[ lkernelWidthDF * lkernelHeightDF ];
<a name="l00539"></a>00539     lkernelDF[0]=1;lkernelDF[1]=1;lkernelDF[2]=1;
<a name="l00540"></a>00540     lkernelDF[3]=1;lkernelDF[4]=0;lkernelDF[5]=1;
<a name="l00541"></a>00541     lkernelDF[6]=1;lkernelDF[7]=1;lkernelDF[8]=1;
<a name="l00542"></a>00542     <span class="keyword">const</span> <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> lsrc_dilated=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a> (lsrc-&gt;width(),lsrc-&gt;height(),lsrc-&gt;numBands() );
<a name="l00543"></a>00543     <a class="code" href="classkl_copy_functor.html">klCopyFunctor&lt;unsigned char&gt;</a> klcfdf_u8(lsrc, lsrc_dilated);
<a name="l00544"></a>00544     klcfdf_u8();<span class="comment">//Do the copy</span>
<a name="l00545"></a>00545     <a class="code" href="classkl_dilate_functor.html">klDilateFunctor&lt; unsigned char&gt;</a> kldf_u8( lsrc,  lsrc_dilated,  lkernelDF,  lkernelWidthDF, lkernelHeightDF);
<a name="l00546"></a>00546     kldf_u8();
<a name="l00547"></a>00547     <span class="keyword">delete</span> lkernelDF;
<a name="l00548"></a>00548     <a class="code" href="kl__ppm__image__io_8cpp.html#abd4e33d1b3a2a25e1a64f8a52a101150">write_ppm</a>(<span class="stringliteral">&quot;WSI_DILATED_u8_C3R.ppm&quot;</span>, lsrc_dilated-&gt;width(), lsrc_dilated-&gt;height(),lsrc_dilated-&gt;buffer());
<a name="l00549"></a>00549     
<a name="l00550"></a>00550     
<a name="l00551"></a>00551     <span class="keywordtype">unsigned</span> lkernelWidthEF=3;
<a name="l00552"></a>00552     <span class="keywordtype">unsigned</span> lkernelHeightEF=3;
<a name="l00553"></a>00553     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* lkernelEF = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[ lkernelWidthEF * lkernelHeightEF ];
<a name="l00554"></a>00554     lkernelEF[0]=1;lkernelEF[1]=1;lkernelEF[2]=1;
<a name="l00555"></a>00555     lkernelEF[3]=1;lkernelEF[4]=0;lkernelEF[5]=1;
<a name="l00556"></a>00556     lkernelEF[6]=1;lkernelEF[7]=1;lkernelEF[8]=1;
<a name="l00557"></a>00557     <span class="keyword">const</span> <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> lsrc_erroded=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a> (lsrc-&gt;width(),lsrc-&gt;height(),lsrc-&gt;numBands());
<a name="l00558"></a>00558     <a class="code" href="classkl_copy_functor.html">klCopyFunctor&lt;unsigned char&gt;</a> klcfef_u8(lsrc_dilated, lsrc_erroded);
<a name="l00559"></a>00559     klcfef_u8();<span class="comment">//Do the copy</span>
<a name="l00560"></a>00560     
<a name="l00561"></a>00561     <a class="code" href="classkl_erode_functor.html">klErodeFunctor&lt; unsigned char&gt;</a> klef_u8( lsrc_dilated,  lsrc_erroded,  lkernelEF,  lkernelWidthEF, lkernelHeightEF);
<a name="l00562"></a>00562     klef_u8();<span class="comment">//Do the errode</span>
<a name="l00563"></a>00563     <span class="keyword">delete</span> lkernelEF;
<a name="l00564"></a>00564     <a class="code" href="kl__ppm__image__io_8cpp.html#abd4e33d1b3a2a25e1a64f8a52a101150">write_ppm</a>(<span class="stringliteral">&quot;WSI_ERRODED_u8_C3R.ppm&quot;</span>, lsrc_erroded-&gt;width(), lsrc_erroded-&gt;height(),lsrc_erroded-&gt;buffer());
<a name="l00565"></a>00565 
<a name="l00566"></a>00566     <span class="comment">//Make the src image the opened image</span>
<a name="l00567"></a>00567     <a class="code" href="classkl_copy_functor.html">klCopyFunctor&lt;unsigned char&gt;</a> klcfdf_op_sr_u8(lsrc_erroded,lsrc);
<a name="l00568"></a>00568     klcfdf_op_sr_u8();<span class="comment">//Do the copy</span>
<a name="l00570"></a>00570 <span class="comment"></span>
<a name="l00571"></a>00571 
<a name="l00573"></a>00573     <span class="comment">//Maps [0,thresholdLow] U [thresholdHigh,MAXVAL(TYPE) ] -----&gt; LowVal , HighVal</span>
<a name="l00574"></a>00574     <span class="keywordtype">double</span> lthresholdLow=252;
<a name="l00575"></a>00575     <span class="keywordtype">double</span> lthresholdLowVal=0;
<a name="l00576"></a>00576 
<a name="l00577"></a>00577     <span class="keywordtype">double</span> lthresholdHi=253;
<a name="l00578"></a>00578     <span class="keywordtype">double</span> lthresholdHiVal=255;
<a name="l00579"></a>00579 
<a name="l00580"></a>00580     <span class="keywordtype">bool</span> luseLowThreshold=<span class="keyword">true</span>;
<a name="l00581"></a>00581     <span class="keywordtype">bool</span> luseHighThreshold=<span class="keyword">true</span>;
<a name="l00582"></a>00582     
<a name="l00583"></a>00583     <span class="keywordtype">bool</span> luseThresholdVals=<span class="keyword">true</span>;
<a name="l00584"></a>00584     <a class="code" href="classkl_threshold_functor.html">klThresholdFunctor&lt;unsigned char&gt;</a> kltf_RBG_u8( lsrc, lthresholdHi, lthresholdLow,luseLowThreshold,luseHighThreshold,lthresholdHiVal,lthresholdLowVal, luseThresholdVals);
<a name="l00585"></a>00585     kltf_RBG_u8();
<a name="l00586"></a>00586     <a class="code" href="kl__ppm__image__io_8cpp.html#abd4e33d1b3a2a25e1a64f8a52a101150">write_ppm</a> (<span class="stringliteral">&quot;WSI_THRESHOLDED_RGB.ppm&quot;</span>, lsrc-&gt;width(), lsrc-&gt;height(),lsrc-&gt;buffer());
<a name="l00588"></a>00588 
<a name="l00589"></a>00589     <span class="keyword">const</span> <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> lsrc_logical_B1=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a> (lsrc-&gt;width(),lsrc-&gt;height(),1 );
<a name="l00590"></a>00590     <span class="keyword">const</span> <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> lsrc_logical_B2=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a> (lsrc-&gt;width(),lsrc-&gt;height(),1 );
<a name="l00591"></a>00591     <span class="keyword">const</span> <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> lsrc_logical_B3=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a> (lsrc-&gt;width(),lsrc-&gt;height(),1 );
<a name="l00592"></a>00592 
<a name="l00593"></a>00593     <span class="keyword">const</span> <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> logical_result=<span class="keyword">new</span> <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a> (lsrc-&gt;width(),lsrc-&gt;height(),1 );
<a name="l00594"></a>00594         
<a name="l00595"></a>00595     <a class="code" href="classkl_copy_functor.html">klCopyFunctor&lt;unsigned char&gt;</a> klcflf_B1_u8(lsrc, lsrc_logical_B1,0);
<a name="l00596"></a>00596     klcflf_B1_u8();
<a name="l00597"></a>00597     <a class="code" href="kl__ppm__image__io_8cpp.html#a59c449d0876be18f00f00c11a3e23836">write_ppm_single_band</a>(<span class="stringliteral">&quot;WSI_B1.pgm&quot;</span>, lsrc_logical_B1-&gt;width(), lsrc_logical_B1-&gt;height(),lsrc_logical_B1-&gt;buffer());
<a name="l00598"></a>00598     
<a name="l00599"></a>00599     <a class="code" href="classkl_copy_functor.html">klCopyFunctor&lt;unsigned char&gt;</a> klcflf_B2_u8(lsrc, lsrc_logical_B2,1);
<a name="l00600"></a>00600     klcflf_B2_u8();
<a name="l00601"></a>00601     <a class="code" href="kl__ppm__image__io_8cpp.html#a59c449d0876be18f00f00c11a3e23836">write_ppm_single_band</a>(<span class="stringliteral">&quot;WSI_B2.pgm&quot;</span>, lsrc_logical_B2-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a1c1a57f455690160e825073e3b297c9c">width</a>(), lsrc_logical_B2-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a700315115a5375ef88c78b311139d7d9">height</a>(),lsrc_logical_B2-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a0b9e8748d6febe81c5803003a38c9b9a">buffer</a>());
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     <a class="code" href="classkl_copy_functor.html">klCopyFunctor&lt;unsigned char&gt;</a> klcflf_B3_u8(lsrc, lsrc_logical_B3,2);
<a name="l00604"></a>00604     klcflf_B3_u8();
<a name="l00605"></a>00605     <a class="code" href="kl__ppm__image__io_8cpp.html#a59c449d0876be18f00f00c11a3e23836">write_ppm_single_band</a>(<span class="stringliteral">&quot;WSI_B3.pgm&quot;</span>, lsrc_logical_B3-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a1c1a57f455690160e825073e3b297c9c">width</a>(), lsrc_logical_B3-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a700315115a5375ef88c78b311139d7d9">height</a>(),lsrc_logical_B3-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a0b9e8748d6febe81c5803003a38c9b9a">buffer</a>());
<a name="l00606"></a>00606 
<a name="l00607"></a>00607     <a class="code" href="classkl_logical_functor.html">klLogicalFunctor</a> klflf_u8(lsrc_logical_B1, lsrc_logical_B2, logical_result,klLogicalFunctor::LogicalFunctorOperationType::AND);
<a name="l00608"></a>00608     klflf_u8();
<a name="l00609"></a>00609     <a class="code" href="kl__ppm__image__io_8cpp.html#a59c449d0876be18f00f00c11a3e23836">write_ppm_single_band</a>(<span class="stringliteral">&quot;WSI_LOGICAL_C1R.pgm&quot;</span>, logical_result-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a1c1a57f455690160e825073e3b297c9c">width</a>(), logical_result-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a700315115a5375ef88c78b311139d7d9">height</a>(),logical_result-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a0b9e8748d6febe81c5803003a38c9b9a">buffer</a>());
<a name="l00610"></a>00610 
<a name="l00611"></a>00611     <a class="code" href="classkl_fill_holes_functor.html">klFillHolesFunctor&lt;unsigned char&gt;</a> klfhf_NOT_GREEN_u8(lsrc_logical_B2,0,255);
<a name="l00612"></a>00612     klfhf_NOT_GREEN_u8();
<a name="l00613"></a>00613     <a class="code" href="kl__ppm__image__io_8cpp.html#a59c449d0876be18f00f00c11a3e23836">write_ppm_single_band</a> (<span class="stringliteral">&quot;WSI_HOLEFILL_B2.pgm&quot;</span>, lsrc_logical_B2-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a1c1a57f455690160e825073e3b297c9c">width</a>(), lsrc_logical_B2-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a700315115a5375ef88c78b311139d7d9">height</a>(),lsrc_logical_B2-&gt;<a class="code" href="classkl_packed_heap_raster_buffer.html#a0b9e8748d6febe81c5803003a38c9b9a">buffer</a>());
<a name="l00614"></a>00614 
<a name="l00615"></a>00615     <span class="keywordflow">return</span> 42;
<a name="l00616"></a>00616 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Mon Apr 21 2014 10:04:36 for klImageCore by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
