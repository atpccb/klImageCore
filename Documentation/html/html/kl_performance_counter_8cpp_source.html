<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>klImageCore: klPerformanceCounter.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>klPerformanceCounter.cpp</h1>  </div>
</div>
<div class="contents">
<a href="kl_performance_counter_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*******************************</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) &lt;2007&gt;, &lt;Bruce Campbell&gt; All rights reserved. Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met: 1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  </span>
<a name="l00003"></a>00003 <span class="comment"> * Bruce B Campbell 11 30 2012  *</span>
<a name="l00004"></a>00004 <span class="comment"> ********************************/</span>
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="preprocessor">#include &quot;<a class="code" href="_stdafx_8h.html">stdafx.h</a>&quot;</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="preprocessor">#include &quot;<a class="code" href="kl_performance_counter_8h.html">klPerformanceCounter.h</a>&quot;</span>
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 <span class="preprocessor">#using &lt;System.dll&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor"></span>
<a name="l00012"></a>00012 <span class="keyword">using namespace </span>System;
<a name="l00013"></a>00013 <span class="keyword">using namespace </span>System::Collections;
<a name="l00014"></a>00014 <span class="keyword">using namespace </span>System::Collections::Specialized;
<a name="l00015"></a>00015 <span class="keyword">using namespace </span>System::Diagnostics;
<a name="l00016"></a>00016 <span class="keyword">using namespace </span>klCounters;
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="comment">//Output information about the counter sample.</span>
<a name="l00019"></a><a class="code" href="classkl_counters_1_1kl_performance_counter.html#af1568682e174dba63fe71ef87a3127ff">00019</a> <span class="keywordtype">void</span> klPerformanceCounter::OutputSample( CounterSample s )
<a name="l00020"></a>00020 {
<a name="l00021"></a>00021    Console::WriteLine( <span class="stringliteral">&quot;\r\n+++++++++++&quot;</span> );
<a name="l00022"></a>00022    Console::WriteLine( <span class="stringliteral">&quot;Sample values - \r\n&quot;</span> );
<a name="l00023"></a>00023    Console::WriteLine( <span class="stringliteral">&quot;   BaseValue        = {0}&quot;</span>, s.BaseValue );
<a name="l00024"></a>00024    Console::WriteLine( <span class="stringliteral">&quot;   CounterFrequency = {0}&quot;</span>, s.CounterFrequency );
<a name="l00025"></a>00025    Console::WriteLine( <span class="stringliteral">&quot;   CounterTimeStamp = {0}&quot;</span>, s.CounterTimeStamp );
<a name="l00026"></a>00026    Console::WriteLine( <span class="stringliteral">&quot;   CounterType      = {0}&quot;</span>, s.CounterType );
<a name="l00027"></a>00027    Console::WriteLine( <span class="stringliteral">&quot;   RawValue         = {0}&quot;</span>, s.RawValue );
<a name="l00028"></a>00028    Console::WriteLine( <span class="stringliteral">&quot;   SystemFrequency  = {0}&quot;</span>, s.SystemFrequency );
<a name="l00029"></a>00029    Console::WriteLine( <span class="stringliteral">&quot;   TimeStamp        = {0}&quot;</span>, s.TimeStamp );
<a name="l00030"></a>00030    Console::WriteLine( <span class="stringliteral">&quot;   TimeStamp100nSec = {0}&quot;</span>, s.TimeStamp100nSec );
<a name="l00031"></a>00031    Console::WriteLine( <span class="stringliteral">&quot;++++++++++++++++++++++&quot;</span> );
<a name="l00032"></a>00032 }
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="comment">//++++++++//++++++++//++++++++//++++++++//++++++++//++++++++//++++++++//++++++++</span>
<a name="l00035"></a>00035 <span class="comment">//    Description - This counter type shows how many items are processed, on average,</span>
<a name="l00036"></a>00036 <span class="comment">//        during an operation. Counters of this type display a ratio of the items </span>
<a name="l00037"></a>00037 <span class="comment">//        processed (such as bytes sent) to the number of operations completed. The  </span>
<a name="l00038"></a>00038 <span class="comment">//        ratio is calculated by comparing the number of items processed during the </span>
<a name="l00039"></a>00039 <span class="comment">//        last interval to the number of operations completed during the last interval. </span>
<a name="l00040"></a>00040 <span class="comment">// Generic type - Average</span>
<a name="l00041"></a>00041 <span class="comment">//      Formula - (N1 - N0) / (D1 - D0), where the numerator (N) represents the number </span>
<a name="l00042"></a>00042 <span class="comment">//        of items processed during the last sample interval and the denominator (D) </span>
<a name="l00043"></a>00043 <span class="comment">//        represents the number of operations completed during the last two sample </span>
<a name="l00044"></a>00044 <span class="comment">//        intervals. </span>
<a name="l00045"></a>00045 <span class="comment">//    Average (Nx - N0) / (Dx - D0)  </span>
<a name="l00046"></a>00046 <span class="comment">//    Example PhysicalDisk\ Avg. Disk Bytes/Transfer </span>
<a name="l00047"></a>00047 <span class="comment">//++++++++//++++++++//++++++++//++++++++//++++++++//++++++++//++++++++//++++++++</span>
<a name="l00048"></a><a class="code" href="classkl_counters_1_1kl_performance_counter.html#a2f1f2b8129da1963e876cce94745b2ac">00048</a> <span class="keywordtype">float</span> <a class="code" href="classkl_counters_1_1kl_performance_counter.html#a2f1f2b8129da1963e876cce94745b2ac">klPerformanceCounter::MyComputeCounterValue</a>( CounterSample s0, CounterSample s1 )
<a name="l00049"></a>00049 {
<a name="l00050"></a>00050    <span class="keywordtype">float</span> numerator = (float)s1.RawValue - (<span class="keywordtype">float</span>)s0.RawValue;
<a name="l00051"></a>00051    <span class="keywordtype">float</span> denomenator = (float)s1.BaseValue - (<span class="keywordtype">float</span>)s0.BaseValue;
<a name="l00052"></a>00052    <span class="keywordtype">float</span> counterValue = numerator / denomenator;
<a name="l00053"></a>00053    <span class="keywordflow">return</span> counterValue;
<a name="l00054"></a>00054 }
<a name="l00055"></a>00055 
<a name="l00056"></a><a class="code" href="classkl_counters_1_1kl_performance_counter.html#a3560ea933d3d04c14d72c314ff665fbe">00056</a> <span class="keywordtype">void</span> <a class="code" href="classkl_counters_1_1kl_performance_counter.html#a3560ea933d3d04c14d72c314ff665fbe">klPerformanceCounter::RemoveCategory</a>(String^ Category )
<a name="l00057"></a>00057 {
<a name="l00058"></a>00058 
<a name="l00059"></a>00059     <span class="keywordflow">try</span>
<a name="l00060"></a>00060     {
<a name="l00061"></a>00061         System::Diagnostics::PerformanceCounterCategory::Delete(Category);
<a name="l00062"></a>00062     }
<a name="l00063"></a>00063     <span class="keywordflow">catch</span>(Exception^ e)
<a name="l00064"></a>00064     {
<a name="l00065"></a>00065         <span class="comment">//System::Console::WriteLine(&quot;BOO&quot;):</span>
<a name="l00066"></a>00066     }
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 }
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 
<a name="l00071"></a><a class="code" href="classkl_counters_1_1kl_performance_counter.html#a84101da50c55e6d5e74c86e74d1f9e7d">00071</a> <span class="keywordtype">bool</span> <a class="code" href="classkl_counters_1_1kl_performance_counter.html#a84101da50c55e6d5e74c86e74d1f9e7d">klPerformanceCounter::SetupCategory</a>()
<a name="l00072"></a>00072 {
<a name="l00073"></a>00073    <span class="keywordflow">if</span> (  !PerformanceCounterCategory::Exists( <span class="stringliteral">&quot;klPerformanceCounter&quot;</span> ) )
<a name="l00074"></a>00074    {
<a name="l00075"></a>00075       CounterCreationDataCollection^ CCDC = <span class="keyword">gcnew</span> CounterCreationDataCollection;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077       <span class="comment">// Add the counter.</span>
<a name="l00078"></a>00078       CounterCreationData^ averageCount64 = <span class="keyword">gcnew</span> CounterCreationData;
<a name="l00079"></a>00079       averageCount64-&gt;CounterType = PerformanceCounterType::AverageCount64;
<a name="l00080"></a>00080       averageCount64-&gt;CounterName = <span class="stringliteral">&quot;AverageCounter64Sample&quot;</span>;
<a name="l00081"></a>00081       CCDC-&gt;Add( averageCount64 );
<a name="l00082"></a>00082 
<a name="l00083"></a>00083       <span class="comment">// Add the base counter.</span>
<a name="l00084"></a>00084       CounterCreationData^ averageCount64Base = <span class="keyword">gcnew</span> CounterCreationData;
<a name="l00085"></a>00085       averageCount64Base-&gt;CounterType = PerformanceCounterType::AverageBase;
<a name="l00086"></a>00086       averageCount64Base-&gt;CounterName = <span class="stringliteral">&quot;AverageCounter64SampleBase&quot;</span>;
<a name="l00087"></a>00087       CCDC-&gt;Add( averageCount64Base );
<a name="l00088"></a>00088 
<a name="l00089"></a>00089       <span class="comment">// Create the category.</span>
<a name="l00090"></a>00090       PerformanceCounterCategory::Create( <span class="stringliteral">&quot;klPerformanceCounter&quot;</span>, <span class="stringliteral">&quot;Demonstrates usage of the AverageCounter64 performance counter type.&quot;</span>, CCDC );
<a name="l00091"></a>00091       <span class="keywordflow">return</span> (<span class="keyword">true</span>);
<a name="l00092"></a>00092    }
<a name="l00093"></a>00093    <span class="keywordflow">else</span>
<a name="l00094"></a>00094    {
<a name="l00095"></a>00095       Console::WriteLine( <span class="stringliteral">&quot;Category exists - klPerformanceCounter&quot;</span> );
<a name="l00096"></a>00096       <span class="keywordflow">return</span> (<span class="keyword">false</span>);
<a name="l00097"></a>00097    }
<a name="l00098"></a>00098 }
<a name="l00099"></a>00099 
<a name="l00100"></a><a class="code" href="classkl_counters_1_1kl_performance_counter.html#a1e60973f53b541e9fdfaf2c4fecd319d">00100</a> <span class="keywordtype">void</span> <a class="code" href="classkl_counters_1_1kl_performance_counter.html#a1e60973f53b541e9fdfaf2c4fecd319d">klPerformanceCounter::CreateCounters</a>( PerformanceCounter^% PC, PerformanceCounter^% BPC )
<a name="l00101"></a>00101 {
<a name="l00102"></a>00102 
<a name="l00103"></a>00103    <span class="comment">// Create the counters.</span>
<a name="l00104"></a>00104    PC = <span class="keyword">gcnew</span> PerformanceCounter( <span class="stringliteral">&quot;klPerformanceCounter&quot;</span>,<span class="stringliteral">&quot;AverageCounter64Sample&quot;</span>,<span class="keyword">false</span> );
<a name="l00105"></a>00105 
<a name="l00106"></a>00106    BPC = <span class="keyword">gcnew</span> PerformanceCounter( <span class="stringliteral">&quot;klPerformanceCounter&quot;</span>,<span class="stringliteral">&quot;AverageCounter64SampleBase&quot;</span>,<span class="keyword">false</span> );
<a name="l00107"></a>00107    PC-&gt;RawValue = 0;
<a name="l00108"></a>00108    BPC-&gt;RawValue = 0;
<a name="l00109"></a>00109 }
<a name="l00110"></a><a class="code" href="classkl_counters_1_1kl_performance_counter.html#a60608e288abb5485f3e2fdad379f627f">00110</a> <span class="keywordtype">void</span> <a class="code" href="classkl_counters_1_1kl_performance_counter.html#a60608e288abb5485f3e2fdad379f627f">klPerformanceCounter::CollectSamples</a>( ArrayList^ samplesList, PerformanceCounter^ PC, PerformanceCounter^ BPC )
<a name="l00111"></a>00111 {
<a name="l00112"></a>00112    Random^ r = <span class="keyword">gcnew</span> Random( DateTime::Now.Millisecond );
<a name="l00113"></a>00113 
<a name="l00114"></a>00114    <span class="comment">// Loop for the samples.</span>
<a name="l00115"></a>00115    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> j = 0; j &lt; 100; j++ )
<a name="l00116"></a>00116    {
<a name="l00117"></a>00117       <span class="keywordtype">int</span> value = r-&gt;Next( 1, 10 );
<a name="l00118"></a>00118       Console::Write( <span class="stringliteral">&quot;{0} = {1}&quot;</span>, j, value );
<a name="l00119"></a>00119       PC-&gt;IncrementBy( value );
<a name="l00120"></a>00120       BPC-&gt;Increment();
<a name="l00121"></a>00121       <span class="keywordflow">if</span> ( (j % 10) == 9 )
<a name="l00122"></a>00122       {
<a name="l00123"></a>00123          <a class="code" href="classkl_counters_1_1kl_performance_counter.html#af1568682e174dba63fe71ef87a3127ff">OutputSample</a>( PC-&gt;NextSample() );
<a name="l00124"></a>00124          samplesList-&gt;Add( PC-&gt;NextSample() );
<a name="l00125"></a>00125       }
<a name="l00126"></a>00126       <span class="keywordflow">else</span>
<a name="l00127"></a>00127             Console::WriteLine();
<a name="l00128"></a>00128       System::Threading::Thread::Sleep( 50 );
<a name="l00129"></a>00129    }
<a name="l00130"></a>00130 }
<a name="l00131"></a>00131 
<a name="l00132"></a><a class="code" href="classkl_counters_1_1kl_performance_counter.html#a27b6f42d80f5fa3e16bff8c766f11c6c">00132</a> <span class="keywordtype">void</span> <a class="code" href="classkl_counters_1_1kl_performance_counter.html#a27b6f42d80f5fa3e16bff8c766f11c6c">klPerformanceCounter::CalculateResults</a>( ArrayList^ samplesList )
<a name="l00133"></a>00133 {
<a name="l00134"></a>00134    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; (samplesList-&gt;Count - 1); i++ )
<a name="l00135"></a>00135    {
<a name="l00136"></a>00136       <span class="comment">// Output the sample.</span>
<a name="l00137"></a>00137       <a class="code" href="classkl_counters_1_1kl_performance_counter.html#af1568682e174dba63fe71ef87a3127ff">OutputSample</a>(  *safe_cast&lt;CounterSample^&gt;(samplesList[ i ]) );
<a name="l00138"></a>00138       <a class="code" href="classkl_counters_1_1kl_performance_counter.html#af1568682e174dba63fe71ef87a3127ff">OutputSample</a>(  *safe_cast&lt;CounterSample^&gt;(samplesList[ i + 1 ]) );
<a name="l00139"></a>00139 
<a name="l00140"></a>00140       <span class="comment">// Use .NET to calculate the counter value.</span>
<a name="l00141"></a>00141       Console::WriteLine( <span class="stringliteral">&quot;.NET computed counter value = {0}&quot;</span>, CounterSampleCalculator::ComputeCounterValue(  *safe_cast&lt;CounterSample^&gt;(samplesList[ i ]),  *safe_cast&lt;CounterSample^&gt;(samplesList[ i + 1 ]) ) );
<a name="l00142"></a>00142 
<a name="l00143"></a>00143       <span class="comment">// Calculate the counter value manually.</span>
<a name="l00144"></a>00144       Console::WriteLine( <span class="stringliteral">&quot;My computed counter value = {0}&quot;</span>, <a class="code" href="classkl_counters_1_1kl_performance_counter.html#a2f1f2b8129da1963e876cce94745b2ac">MyComputeCounterValue</a>(  *safe_cast&lt;CounterSample^&gt;(samplesList[ i ]),  *safe_cast&lt;CounterSample^&gt;(samplesList[ i + 1 ]) ) );
<a name="l00145"></a>00145    }
<a name="l00146"></a>00146 }
<a name="l00147"></a>00147 
<a name="l00148"></a><a class="code" href="classkl_counters_1_1kl_performance_counter.html#ab8291a6139d93a726dcdbcc4f8e25d7a">00148</a> <span class="keywordtype">int</span> <a class="code" href="classkl_counters_1_1kl_performance_counter.html#ab8291a6139d93a726dcdbcc4f8e25d7a">klPerformanceCounter::TestPerformanceCounter</a>()
<a name="l00149"></a>00149 {
<a name="l00150"></a>00150    ArrayList^ samplesList = <span class="keyword">gcnew</span> ArrayList;
<a name="l00151"></a>00151    PerformanceCounter^ PC;
<a name="l00152"></a>00152    PerformanceCounter^ BPC;
<a name="l00153"></a>00153    <a class="code" href="classkl_counters_1_1kl_performance_counter.html#a84101da50c55e6d5e74c86e74d1f9e7d">SetupCategory</a>();
<a name="l00154"></a>00154    <a class="code" href="classkl_counters_1_1kl_performance_counter.html#a1e60973f53b541e9fdfaf2c4fecd319d">CreateCounters</a>( PC, BPC );
<a name="l00155"></a>00155    <a class="code" href="classkl_counters_1_1kl_performance_counter.html#a60608e288abb5485f3e2fdad379f627f">CollectSamples</a>( samplesList, PC, BPC );
<a name="l00156"></a>00156    <a class="code" href="classkl_counters_1_1kl_performance_counter.html#a27b6f42d80f5fa3e16bff8c766f11c6c">CalculateResults</a>( samplesList );
<a name="l00157"></a>00157    <span class="keywordflow">return</span> 42;
<a name="l00158"></a>00158 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Mon Apr 21 2014 10:04:36 for klImageCore by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
