<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>klImageCore: AperioFileManager.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>AperioFileManager.h</h1>  </div>
</div>
<div class="contents">
<a href="_aperio_file_manager_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*******************************</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) &lt;2007&gt;, &lt;Bruce Campbell&gt; All rights reserved. Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met: 1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  </span>
<a name="l00003"></a>00003 <span class="comment"> * Bruce B Campbell 11 30 2012  *</span>
<a name="l00004"></a>00004 <span class="comment"> ********************************/</span>
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="preprocessor">#ifndef __SVSReader__</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor">#define __SVSReader__</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;<a class="code" href="_stdafx_8h.html">stdafx.h</a>&quot;</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;string&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;vector&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;map&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;sstream&gt;</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="comment">//using namespace std;</span>
<a name="l00019"></a>00019 <span class="comment">//Generic numeric conversion.  The second param, should be std::hex, std::dec or std::oct.</span>
<a name="l00020"></a><a class="code" href="_aperio_file_manager_8h.html#aa4861a4f703cb58248b93638941b87d6">00020</a> <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt; std::string <a class="code" href="_aperio_file_manager_8h.html#aa4861a4f703cb58248b93638941b87d6">num_to_string</a>(T t, std::ios_base &amp; (*f)(std::ios_base&amp;))
<a name="l00021"></a>00021 {
<a name="l00022"></a>00022   std::ostringstream oss;
<a name="l00023"></a>00023   oss &lt;&lt; f &lt;&lt; t;
<a name="l00024"></a>00024   <span class="keywordflow">return</span> oss.str();
<a name="l00025"></a>00025 }
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;malloc.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;tiffio.h&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include&quot;tiffiop.h&quot;</span>
<a name="l00034"></a><a class="code" href="_aperio_file_manager_8h.html#ad342ac907eb044443153a22f964bf0af">00034</a> <span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>  DWORD;
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;kl_SEH.h&quot;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="comment">//This function is a custom tiff error handler defined in SVSReader.cpp.</span>
<a name="l00040"></a>00040 <span class="comment">//It throws an exception of type SVSTiffError</span>
<a name="l00041"></a>00041 <span class="keywordtype">void</span> <a class="code" href="_aperio_file_manager_8cpp.html#a837769c887e80a27facc3a3115dbb3d2">TIFFError</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* module, <span class="keyword">const</span> <span class="keywordtype">char</span>* fmt, va_list argptr);
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="comment">//This function is a custom tiff error handler defined in SVSReader.cpp.</span>
<a name="l00045"></a>00045 <span class="comment">//It throws an exception of type SVSTiffError</span>
<a name="l00046"></a>00046 <span class="keywordtype">void</span> <a class="code" href="_aperio_file_manager_8cpp.html#a8342414f4acf60e26efcf39f482d6558">TIFFErrorExtFn</a>(thandle_t fd, <span class="keyword">const</span> <span class="keywordtype">char</span>* module, <span class="keyword">const</span> <span class="keywordtype">char</span>* fmt, va_list argptr);
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="comment">//Exception type for tiff errors</span>
<a name="l00049"></a><a class="code" href="class_s_v_s_tiff_error.html">00049</a> <span class="keyword">class </span><a class="code" href="class_s_v_s_tiff_error.html">SVSTiffError</a> : <span class="keyword">public</span>  std::exception <span class="comment">//klStackTraceException</span>
<a name="l00050"></a>00050 {
<a name="l00051"></a>00051 <span class="keyword">public</span>:
<a name="l00052"></a><a class="code" href="class_s_v_s_tiff_error.html#a1f33c693149150f902d040084f8d3eb0">00052</a>     <a class="code" href="class_s_v_s_tiff_error.html#a1f33c693149150f902d040084f8d3eb0">SVSTiffError</a>(std::string msg) : exception(msg.c_str() )<span class="comment">//exception( (msg+ klStackWalkFn()).c_str() ) </span>
<a name="l00053"></a>00053     {
<a name="l00054"></a>00054     
<a name="l00055"></a>00055     }
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 };
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="comment">//SVS is one of Aperio’s proprietary image formats for scanned image data.  </span>
<a name="l00061"></a>00061 <span class="comment">//It is a modified tiff format allowing for BigTIff extensions which support more than 4GB of image data.  </span>
<a name="l00062"></a>00062 <span class="comment">//Tiff Directory Structure of SVS File :</span>
<a name="l00063"></a>00063 <span class="comment">//  Each SVS file has multiple images. </span>
<a name="l00064"></a>00064 <span class="comment">//  Dir 1: Main Image compressed according to one of the compression formats listed below.</span>
<a name="l00065"></a>00065 <span class="comment">//  Dir2: An Image thumbnail typically 1024x768</span>
<a name="l00066"></a>00066 <span class="comment">//  Dirs3-5  [Optional] A multi-resolution pyramid compressed with the same format as the main image</span>
<a name="l00067"></a>00067 <span class="comment">//  Dir 6 – 7:  [Optional] LZW compressed Label Image and or JPEG compressed Macro Whole Slide Image  </span>
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="comment">//Aperio Compression / associated file extension:</span>
<a name="l00070"></a>00070 <span class="comment">//  0=None          [ .tif ]</span>
<a name="l00071"></a>00071 <span class="comment">//  1=LZW           [ .tif ]</span>
<a name="l00072"></a>00072 <span class="comment">//  2=SVS w/JPEG    [ .svs ]</span>
<a name="l00073"></a>00073 <span class="comment">//  3=SVS w/J2K     [ .svs ]</span>
<a name="l00074"></a>00074 <span class="comment">//  7=YUYV          [ .tif ]</span>
<a name="l00075"></a>00075 <span class="comment">//  8=JPEG          [ .tif ]  </span>
<a name="l00076"></a>00076 <span class="comment">//For the first version of Aperio file ingestion, we will be using BigTiff enabled libtiff [ver 4.0.0.beta4] from remotesensing.org.  </span>
<a name="l00077"></a>00077 <span class="comment">//Initially, Kakadu 6.1 will provide Jpeg 2000 decompression , Jpeg 6.b will provide standard decompression,  and Libz 1.2.3 will provide LZW decompression.</span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="comment">//AperioFileManager is the main class for controlling all functionality inSVSCompositeLib.</span>
<a name="l00080"></a>00080 <span class="comment">//It manages the extraction of image data and metadata for Aperio image files.</span>
<a name="l00081"></a>00081 <span class="comment">//The name is somewhat of a misnomer, since some Aperio files are saved with a tiff extension</span>
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 <span class="comment">//TODO:  </span>
<a name="l00085"></a>00085 <span class="comment">//IPP/MKL libs may be incorporated in SVSComposite Lib to provide alternate decompression.</span>
<a name="l00086"></a>00086 <span class="comment">//#include &quot;ipp.h&quot;</span>
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 <span class="comment">//This embedded class represents data obtained from a tiff directory.</span>
<a name="l00089"></a><a class="code" href="class_tiff_image_info.html">00089</a> <span class="keyword">class </span><a class="code" href="class_tiff_image_info.html">TiffImageInfo</a> {
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 <span class="keyword">public</span>:
<a name="l00092"></a>00092 
<a name="l00093"></a><a class="code" href="class_tiff_image_info.html#ac111118ef6c2711fd0696fc982702891">00093</a>     <a class="code" href="class_tiff_image_info.html#ac111118ef6c2711fd0696fc982702891">TiffImageInfo</a>()     
<a name="l00094"></a>00094     {
<a name="l00095"></a>00095         <a class="code" href="class_tiff_image_info.html#a33f5cc83ba9e8b10edb62ad892ec9ff4">tiffDirs</a>=0, <a class="code" href="class_tiff_image_info.html#aaaf8cf496f4fc1b4665bb69e82145630">height</a>=0, <a class="code" href="class_tiff_image_info.html#a6ba6b658cece17237edd397e41d824d8">width</a>=0, <a class="code" href="class_tiff_image_info.html#a6e5ddb43fbb34f3404f0e9dd07b29e55">bitspersample</a>=0, <a class="code" href="class_tiff_image_info.html#a031ac8171dfb1320e6df251971bd5145">samplesperpixel</a>=0, <a class="code" href="class_tiff_image_info.html#a80cbf54a969ea6d4863fd632540f9d55">rowsperstrip</a>=0, <a class="code" href="class_tiff_image_info.html#a93c98ae19fb55c62876e45954f3fa885">photometric</a>=0, <a class="code" href="class_tiff_image_info.html#ad5d27eefbeabb4bd5ed0a1d920fc9f7f">compression</a>=0, 
<a name="l00096"></a>00096         <a class="code" href="class_tiff_image_info.html#aa66c59d274881ca68848e3dc79345c9f">orientation</a>=0, <a class="code" href="class_tiff_image_info.html#abfc8a96e543ae3ff4b11500f1ee3277a">res_unit</a>=0, <a class="code" href="class_tiff_image_info.html#aaed7e7d3ed87fde6996774c6d0840581">x</a>=0, <a class="code" href="class_tiff_image_info.html#a23aa03338b008e3685abce66ada9a7ec">y</a>=0, <a class="code" href="class_tiff_image_info.html#a57714dd42d678830a5adb5051790976d">xresolution</a>=0, <a class="code" href="class_tiff_image_info.html#a126a40ba4df6ff3c8b6661bfdb901e4b">xoffset</a>=0, <a class="code" href="class_tiff_image_info.html#a375664d30bc8a34d45a9756975a725fe">yresolution</a>=0,  <a class="code" href="class_tiff_image_info.html#aab8bfc6c0d0478f86e06324cc7c5f7f8">yoffset</a>=0, <a class="code" href="class_tiff_image_info.html#a7516b574703010eead26a095cd232e77">isRGB</a>=0, <a class="code" href="class_tiff_image_info.html#a1be0a96b47d0c70b60122b09613a9b17">isTiled</a>=0, 
<a name="l00097"></a>00097         <a class="code" href="class_tiff_image_info.html#a8be76e7f50738714fcc15b4598742662">tileWidth</a>=0, <a class="code" href="class_tiff_image_info.html#aa47fe0b5d92ec99529ed49f8d7afc941">tileHeight</a>=0, <a class="code" href="class_tiff_image_info.html#a10d1aae8fca1d60efab42db48928c3b1">isBigTiff</a>=0, <a class="code" href="class_tiff_image_info.html#a1b1472e4e790b5561c78a4a49fd1a7a8">tiffTileMemSz</a>=0, <a class="code" href="class_tiff_image_info.html#a684a3945d183ca08b5e4b790867ae5d1">numberOfStrips</a>=0, <a class="code" href="class_tiff_image_info.html#af8394e3e2e6ea5193a55308cc96f6492">stripByteCounts</a>=0, <a class="code" href="class_tiff_image_info.html#a7d4ca5c08d4b006c385c863aac761c6b">isInterleaved</a>=0, 
<a name="l00098"></a>00098         <a class="code" href="class_tiff_image_info.html#a37d8a928ccf5c2a44f99fb16864a7768">isSubsample</a>=0, <a class="code" href="class_tiff_image_info.html#acdb5f87e24c1b71c92c8699afe2a3e6f">ImageDescription</a>=<span class="stringliteral">&quot;&quot;</span>, <a class="code" href="class_tiff_image_info.html#a148a801304107fd227479e9e50f6ddf6">readEntireImage</a>=0;
<a name="l00099"></a>00099     }
<a name="l00100"></a>00100 
<a name="l00101"></a>00101     <span class="comment">//Number of images in tiff file</span>
<a name="l00102"></a><a class="code" href="class_tiff_image_info.html#a33f5cc83ba9e8b10edb62ad892ec9ff4">00102</a>     uint32 <a class="code" href="class_tiff_image_info.html#a33f5cc83ba9e8b10edb62ad892ec9ff4">tiffDirs</a>;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104     <span class="comment">//The dir currently represented by this object</span>
<a name="l00105"></a><a class="code" href="class_tiff_image_info.html#a0402a0e788d642154d0d1ae715efe742">00105</a>     uint16 <a class="code" href="class_tiff_image_info.html#a0402a0e788d642154d0d1ae715efe742">currentDir</a>;
<a name="l00106"></a>00106 
<a name="l00107"></a><a class="code" href="class_tiff_image_info.html#aaaf8cf496f4fc1b4665bb69e82145630">00107</a>     uint32 <a class="code" href="class_tiff_image_info.html#aaaf8cf496f4fc1b4665bb69e82145630">height</a>;
<a name="l00108"></a>00108 
<a name="l00109"></a><a class="code" href="class_tiff_image_info.html#a6ba6b658cece17237edd397e41d824d8">00109</a>     uint32 <a class="code" href="class_tiff_image_info.html#a6ba6b658cece17237edd397e41d824d8">width</a>;
<a name="l00110"></a>00110 
<a name="l00111"></a><a class="code" href="class_tiff_image_info.html#a6e5ddb43fbb34f3404f0e9dd07b29e55">00111</a>     uint16 <a class="code" href="class_tiff_image_info.html#a6e5ddb43fbb34f3404f0e9dd07b29e55">bitspersample</a>;
<a name="l00112"></a>00112 
<a name="l00113"></a><a class="code" href="class_tiff_image_info.html#a031ac8171dfb1320e6df251971bd5145">00113</a>     uint16 <a class="code" href="class_tiff_image_info.html#a031ac8171dfb1320e6df251971bd5145">samplesperpixel</a>;
<a name="l00114"></a>00114 
<a name="l00115"></a><a class="code" href="class_tiff_image_info.html#a80cbf54a969ea6d4863fd632540f9d55">00115</a>     uint32 <a class="code" href="class_tiff_image_info.html#a80cbf54a969ea6d4863fd632540f9d55">rowsperstrip</a>;
<a name="l00116"></a>00116 
<a name="l00117"></a><a class="code" href="class_tiff_image_info.html#a93c98ae19fb55c62876e45954f3fa885">00117</a>     uint16 <a class="code" href="class_tiff_image_info.html#a93c98ae19fb55c62876e45954f3fa885">photometric</a>;
<a name="l00118"></a>00118 
<a name="l00119"></a><a class="code" href="class_tiff_image_info.html#ad5d27eefbeabb4bd5ed0a1d920fc9f7f">00119</a>     uint16 <a class="code" href="class_tiff_image_info.html#ad5d27eefbeabb4bd5ed0a1d920fc9f7f">compression</a>;
<a name="l00120"></a>00120 
<a name="l00121"></a><a class="code" href="class_tiff_image_info.html#aa66c59d274881ca68848e3dc79345c9f">00121</a>     uint16 <a class="code" href="class_tiff_image_info.html#aa66c59d274881ca68848e3dc79345c9f">orientation</a>; 
<a name="l00122"></a>00122 
<a name="l00123"></a><a class="code" href="class_tiff_image_info.html#abfc8a96e543ae3ff4b11500f1ee3277a">00123</a>     uint16 <a class="code" href="class_tiff_image_info.html#abfc8a96e543ae3ff4b11500f1ee3277a">res_unit</a>; 
<a name="l00124"></a>00124 
<a name="l00125"></a><a class="code" href="class_tiff_image_info.html#aaed7e7d3ed87fde6996774c6d0840581">00125</a>     uint32  <a class="code" href="class_tiff_image_info.html#aaed7e7d3ed87fde6996774c6d0840581">x</a>;
<a name="l00126"></a>00126 
<a name="l00127"></a><a class="code" href="class_tiff_image_info.html#a23aa03338b008e3685abce66ada9a7ec">00127</a>     uint32  <a class="code" href="class_tiff_image_info.html#a23aa03338b008e3685abce66ada9a7ec">y</a>;
<a name="l00128"></a>00128 
<a name="l00129"></a><a class="code" href="class_tiff_image_info.html#a57714dd42d678830a5adb5051790976d">00129</a>     <span class="keywordtype">float</span> <a class="code" href="class_tiff_image_info.html#a57714dd42d678830a5adb5051790976d">xresolution</a>;
<a name="l00130"></a>00130 
<a name="l00131"></a><a class="code" href="class_tiff_image_info.html#a126a40ba4df6ff3c8b6661bfdb901e4b">00131</a>     <span class="keywordtype">float</span> <a class="code" href="class_tiff_image_info.html#a126a40ba4df6ff3c8b6661bfdb901e4b">xoffset</a>;
<a name="l00132"></a>00132 
<a name="l00133"></a><a class="code" href="class_tiff_image_info.html#a375664d30bc8a34d45a9756975a725fe">00133</a>     <span class="keywordtype">float</span> <a class="code" href="class_tiff_image_info.html#a375664d30bc8a34d45a9756975a725fe">yresolution</a>;
<a name="l00134"></a>00134 
<a name="l00135"></a><a class="code" href="class_tiff_image_info.html#aab8bfc6c0d0478f86e06324cc7c5f7f8">00135</a>     <span class="keywordtype">float</span> <a class="code" href="class_tiff_image_info.html#aab8bfc6c0d0478f86e06324cc7c5f7f8">yoffset</a>;
<a name="l00136"></a>00136 
<a name="l00137"></a>00137     <span class="comment">//This is  deduced from photometric</span>
<a name="l00138"></a><a class="code" href="class_tiff_image_info.html#a7516b574703010eead26a095cd232e77">00138</a>     <span class="keywordtype">bool</span> <a class="code" href="class_tiff_image_info.html#a7516b574703010eead26a095cd232e77">isRGB</a>;
<a name="l00139"></a>00139 
<a name="l00140"></a><a class="code" href="class_tiff_image_info.html#a1be0a96b47d0c70b60122b09613a9b17">00140</a>     <span class="keywordtype">bool</span> <a class="code" href="class_tiff_image_info.html#a1be0a96b47d0c70b60122b09613a9b17">isTiled</a>;
<a name="l00141"></a>00141 
<a name="l00142"></a><a class="code" href="class_tiff_image_info.html#a8be76e7f50738714fcc15b4598742662">00142</a>     uint32 <a class="code" href="class_tiff_image_info.html#a8be76e7f50738714fcc15b4598742662">tileWidth</a>;
<a name="l00143"></a>00143 
<a name="l00144"></a><a class="code" href="class_tiff_image_info.html#aa47fe0b5d92ec99529ed49f8d7afc941">00144</a>     uint32 <a class="code" href="class_tiff_image_info.html#aa47fe0b5d92ec99529ed49f8d7afc941">tileHeight</a>;
<a name="l00145"></a>00145 
<a name="l00146"></a><a class="code" href="class_tiff_image_info.html#a10d1aae8fca1d60efab42db48928c3b1">00146</a>     <span class="keywordtype">bool</span> <a class="code" href="class_tiff_image_info.html#a10d1aae8fca1d60efab42db48928c3b1">isBigTiff</a>;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148     <span class="comment">//# bytes in a variable length, row-aligned tile.</span>
<a name="l00149"></a><a class="code" href="class_tiff_image_info.html#a1b1472e4e790b5561c78a4a49fd1a7a8">00149</a>     tsize_t <a class="code" href="class_tiff_image_info.html#a1b1472e4e790b5561c78a4a49fd1a7a8">tiffTileMemSz</a>;
<a name="l00150"></a>00150 
<a name="l00151"></a><a class="code" href="class_tiff_image_info.html#a684a3945d183ca08b5e4b790867ae5d1">00151</a>     tstrip_t <a class="code" href="class_tiff_image_info.html#a684a3945d183ca08b5e4b790867ae5d1">numberOfStrips</a>;
<a name="l00152"></a>00152 
<a name="l00153"></a>00153     <span class="comment">//This memory is cleaned up when the tiff file is closed/ or when the directory is changed.  -bbcrevisit </span>
<a name="l00154"></a><a class="code" href="class_tiff_image_info.html#af8394e3e2e6ea5193a55308cc96f6492">00154</a>     uint32* <a class="code" href="class_tiff_image_info.html#af8394e3e2e6ea5193a55308cc96f6492">stripByteCounts</a>;
<a name="l00155"></a>00155     
<a name="l00156"></a><a class="code" href="class_tiff_image_info.html#a2bd3afc2d1516ad5957f469e3df6b2a1">00156</a>     uint64* <a class="code" href="class_tiff_image_info.html#a2bd3afc2d1516ad5957f469e3df6b2a1">longOffsets</a>;
<a name="l00157"></a>00157 
<a name="l00158"></a>00158     <span class="comment">//This indicates if the image is band interleaved or planar</span>
<a name="l00159"></a><a class="code" href="class_tiff_image_info.html#a7d4ca5c08d4b006c385c863aac761c6b">00159</a>     <span class="keywordtype">bool</span> <a class="code" href="class_tiff_image_info.html#a7d4ca5c08d4b006c385c863aac761c6b">isInterleaved</a>;  
<a name="l00160"></a>00160 
<a name="l00161"></a><a class="code" href="class_tiff_image_info.html#a37d8a928ccf5c2a44f99fb16864a7768">00161</a>     <span class="keywordtype">bool</span> <a class="code" href="class_tiff_image_info.html#a37d8a928ccf5c2a44f99fb16864a7768">isSubsample</a>;
<a name="l00162"></a>00162 
<a name="l00163"></a>00163     <span class="comment">//This is the string from which Aperio specific metadata is parsed.</span>
<a name="l00164"></a><a class="code" href="class_tiff_image_info.html#acdb5f87e24c1b71c92c8699afe2a3e6f">00164</a>     std::string <a class="code" href="class_tiff_image_info.html#acdb5f87e24c1b71c92c8699afe2a3e6f">ImageDescription</a>;
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     <span class="comment">//bbcrevisit For testing </span>
<a name="l00167"></a><a class="code" href="class_tiff_image_info.html#a148a801304107fd227479e9e50f6ddf6">00167</a>     <span class="keywordtype">bool</span> <a class="code" href="class_tiff_image_info.html#a148a801304107fd227479e9e50f6ddf6">readEntireImage</a>;
<a name="l00168"></a>00168 
<a name="l00169"></a>00169     <span class="comment">//Conversion operator to assist in metadata </span>
<a name="l00170"></a>00170     <a class="code" href="class_tiff_image_info.html#abc56a5358ee370a029c428668ab87adc">operator std::map&lt;std::string, std::string&gt; </a>();
<a name="l00171"></a>00171 }; 
<a name="l00172"></a>00172 
<a name="l00173"></a>00173 
<a name="l00174"></a>00174 <span class="comment">//This class represents access to an svs file.</span>
<a name="l00175"></a>00175 <span class="comment">//It provides the image and Aperio metadata.</span>
<a name="l00176"></a><a class="code" href="class_aperio_file_manager.html">00176</a> <span class="keyword">class </span><a class="code" href="class_aperio_file_manager.html">AperioFileManager</a>
<a name="l00177"></a>00177 {
<a name="l00178"></a>00178 <span class="keyword">public</span>:
<a name="l00179"></a>00179     <span class="comment">//One instance per SVS file.  No resources are created in the constructor save the </span>
<a name="l00180"></a>00180     <span class="comment">//handle to the tiff file.</span>
<a name="l00181"></a>00181     <a class="code" href="class_aperio_file_manager.html#a8712c8def3feae5d27cffe0f2c226580">AperioFileManager</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* fileName);
<a name="l00182"></a>00182 
<a name="l00183"></a>00183     <span class="comment">//Closes tiff file.</span>
<a name="l00184"></a><a class="code" href="class_aperio_file_manager.html#a8444653c80bb7697d16155374ba3a6c9">00184</a>     <a class="code" href="class_aperio_file_manager.html#a8444653c80bb7697d16155374ba3a6c9">~AperioFileManager</a>()
<a name="l00185"></a>00185     {
<a name="l00186"></a>00186         <span class="keywordflow">if</span>(<a class="code" href="class_aperio_file_manager.html#ae6aaf787e1b10cd4d1b58c02e2468225">tifFile</a>)
<a name="l00187"></a>00187         {
<a name="l00188"></a>00188             TIFFClose(<a class="code" href="class_aperio_file_manager.html#ae6aaf787e1b10cd4d1b58c02e2468225">tifFile</a>);
<a name="l00189"></a>00189         }
<a name="l00190"></a>00190         <span class="keywordflow">if</span>(<a class="code" href="class_aperio_file_manager.html#a3f938aff2c136a0d2c22a75ef9ca4422">logFile</a>)
<a name="l00191"></a>00191         {
<a name="l00192"></a>00192             fclose(<a class="code" href="class_aperio_file_manager.html#a3f938aff2c136a0d2c22a75ef9ca4422">logFile</a>);
<a name="l00193"></a>00193         }
<a name="l00194"></a>00194     }
<a name="l00195"></a>00195 
<a name="l00196"></a>00196     <span class="comment">//Get the number of images in this tiff file.</span>
<a name="l00197"></a>00197     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="class_aperio_file_manager.html#a68c47efa0ac310dc395bbe59a09905ca">getNumberOfTiffDirs</a>();
<a name="l00198"></a>00198 
<a name="l00199"></a>00199     <span class="comment">//Get the Whole Slide Image if there is one. </span>
<a name="l00200"></a>00200     <span class="comment">//Returns false if there is none, throws an error if a problem is encountered writing the WSI image. </span>
<a name="l00201"></a>00201     <span class="keywordtype">bool</span> <a class="code" href="class_aperio_file_manager.html#aa21b32bb1c543d1a897a22139df4764c">getWSIImage</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* ofileName);    
<a name="l00202"></a>00202 
<a name="l00203"></a>00203     <span class="comment">//Get the label image if there is one.  </span>
<a name="l00204"></a>00204     <span class="comment">//Returns false if there is none, throws an error if a problem is encountered writing the label image. </span>
<a name="l00205"></a>00205     <span class="keywordtype">bool</span> <a class="code" href="class_aperio_file_manager.html#a6a3dde5d29d68ca127fc075dadbe32cb">getLabelImage</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* ofileName);
<a name="l00206"></a>00206 
<a name="l00207"></a>00207     <span class="comment">//Get the thumbnail image if there is one. </span>
<a name="l00208"></a>00208     <span class="comment">//Returns false if there is none, throws an error if a problem is encountered writing the thumbnail image. </span>
<a name="l00209"></a>00209     <span class="keywordtype">bool</span> <a class="code" href="class_aperio_file_manager.html#a0d6452b6d7cefd389848f2be95a09221">getThumbnail</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* ofileName);
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <span class="comment">//Get the tile image at a specified directory.  </span>
<a name="l00212"></a>00212     <span class="keywordtype">bool</span> <a class="code" href="class_aperio_file_manager.html#a92a18b5f49c8f95711ed8ce964cbac2e">AperioFileManager::getTiffDirImage</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dir, <span class="keyword">const</span> <span class="keywordtype">char</span>* ofileName);
<a name="l00213"></a>00213 
<a name="l00214"></a>00214     <span class="comment">//Get the strip image at a specified directory. </span>
<a name="l00215"></a>00215     <span class="keywordtype">bool</span> <a class="code" href="class_aperio_file_manager.html#ac0876ff34752d650663039e0c834003c">AperioFileManager::getStripSubDir</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dir, <span class="keyword">const</span> <span class="keywordtype">char</span>* ofileName);
<a name="l00216"></a>00216 
<a name="l00217"></a>00217     <span class="comment">//Returns Image and Aperio Metadata in a map format for the specified tiff directory.  </span>
<a name="l00218"></a>00218     <span class="comment">//Throws an error if there is a problem.  The consumer of this is intended to be a managed assembly which puts the metadata in an xml format.</span>
<a name="l00219"></a>00219     std::map&lt;std::string,std::string&gt; <a class="code" href="class_aperio_file_manager.html#a4cd2778a6e2a129879e621d1ee25d0bc">getMetadata</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i);
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     <span class="comment">//Get&#39;s a ROI from the first tiff image.</span>
<a name="l00222"></a>00222     <span class="keywordtype">void</span> <a class="code" href="class_aperio_file_manager.html#abec3417da7fff16c5a491801f223dde1">ExtractMainResTile</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * tiffoutputFile, <span class="keyword">const</span> <span class="keywordtype">char</span> * ppmoutputFile,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> x,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> y,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> w,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> h);
<a name="l00223"></a>00223     
<a name="l00224"></a>00224     <span class="comment">//Get an ROI use the embedded ICC profile.</span>
<a name="l00225"></a>00225     <span class="keywordtype">void</span> <a class="code" href="class_aperio_file_manager.html#ad84acc400420143ee6aa6795e5d69f54">ExtractMainResTileApplyICC</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * outputFile,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> x,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> y,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> w,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> h);
<a name="l00226"></a>00226     
<a name="l00227"></a>00227     <span class="keywordtype">void</span> <a class="code" href="class_aperio_file_manager.html#a2a8481a5c0a709373d75ff7387fd7470">AperioFileManager::ExtractImageTiles</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * outputFileBase);
<a name="l00228"></a>00228 
<a name="l00229"></a>00229     <span class="comment">//Extracts an image buffer from the micro image.  The caller must delete the buffer.</span>
<a name="l00230"></a>00230     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* <a class="code" href="class_aperio_file_manager.html#a8ac2321b5729a930eebf2116209d2d22">getImageBuffer</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> x,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> y,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> w,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> h,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>&amp; tw,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>&amp; th); 
<a name="l00231"></a>00231 
<a name="l00232"></a>00232     <span class="comment">//Print the metadata for all directories to std::cout</span>
<a name="l00233"></a>00233     <span class="keywordtype">void</span> <a class="code" href="class_aperio_file_manager.html#a1b0a68740e1629198f9051273df4676a">printMetadata</a>();
<a name="l00234"></a>00234     
<a name="l00235"></a>00235 <span class="keyword">protected</span>:
<a name="l00236"></a>00236 
<a name="l00237"></a>00237     <span class="comment">//Gets the TiffImageInfo for the specified image.</span>
<a name="l00238"></a>00238     <span class="comment">//This also sets the tifFile tiff handle memeber to the appropriate subdir.</span>
<a name="l00239"></a>00239     <span class="comment">//This is called as a setup and data extraction step prior to reading metadata &amp; image data.</span>
<a name="l00240"></a>00240     <a class="code" href="class_tiff_image_info.html">TiffImageInfo</a> <a class="code" href="class_aperio_file_manager.html#ab21032520a76a590404241b584d4c120">getTiffImageInfo</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i); 
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     <span class="comment">//For test purposes - not used in production </span>
<a name="l00243"></a>00243     <span class="keywordtype">void</span> <a class="code" href="class_aperio_file_manager.html#a1e30e1c10bb9ff1f73eb4e5dc70818c9">writeTiffFile</a>(<span class="keywordtype">char</span>* filename,  <span class="keywordtype">void</span>* raster, <a class="code" href="class_tiff_image_info.html">TiffImageInfo</a> info);  
<a name="l00244"></a>00244 
<a name="l00245"></a>00245     std::vector&lt;std::string&gt; <a class="code" href="class_aperio_file_manager.html#a2b96c23e955e9cd210b49a0493497532">parseImageDescriptionTag</a>(std::string tag);
<a name="l00246"></a>00246 
<a name="l00247"></a>00247     <span class="comment">//This fn merges metadata obtained from Aperio Image Information tag and the other tiff tags.</span>
<a name="l00248"></a>00248     <span class="comment">//The elements parameter contains Aperio data, info contians tiff metadata.</span>
<a name="l00249"></a>00249     std::map&lt;std::string,std::string&gt; <a class="code" href="class_aperio_file_manager.html#ab317a307055c60d62c6bf11a137d2dae">AperioFileManager::createXMLMap</a>(std::vector&lt;std::string&gt; elements, <a class="code" href="class_tiff_image_info.html">TiffImageInfo</a> info);
<a name="l00250"></a>00250 
<a name="l00251"></a>00251     <span class="comment">//Writes the ImageMetadata to file.  Primarily for debugging purposes.</span>
<a name="l00252"></a>00252     <span class="keywordtype">void</span> <a class="code" href="class_aperio_file_manager.html#a5b9256c98c48975b0898aa3268c30b8d">printTiffInfo</a>(FILE* fname, <a class="code" href="class_tiff_image_info.html">TiffImageInfo</a> info);
<a name="l00253"></a>00253 
<a name="l00254"></a>00254     <span class="comment">//This is the handle to the tiff image</span>
<a name="l00255"></a><a class="code" href="class_aperio_file_manager.html#ae6aaf787e1b10cd4d1b58c02e2468225">00255</a>     TIFF * <a class="code" href="class_aperio_file_manager.html#ae6aaf787e1b10cd4d1b58c02e2468225">tifFile</a>; 
<a name="l00256"></a>00256 
<a name="l00257"></a><a class="code" href="class_aperio_file_manager.html#a3f938aff2c136a0d2c22a75ef9ca4422">00257</a>     FILE* <a class="code" href="class_aperio_file_manager.html#a3f938aff2c136a0d2c22a75ef9ca4422">logFile</a>;
<a name="l00258"></a>00258     
<a name="l00259"></a>00259 <span class="keyword">private</span>:
<a name="l00260"></a>00260     <span class="comment">//This method should only be called by getTiffImageInfo</span>
<a name="l00261"></a>00261     <span class="comment">//Sets the tiff directory to the specified image.  </span>
<a name="l00262"></a>00262     <span class="comment">//Throws an error if directory is out of range.</span>
<a name="l00263"></a>00263     <span class="keywordtype">void</span> <a class="code" href="class_aperio_file_manager.html#a4bde73872c5b6463de4304d68694306d">setTiffDirectory</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i);
<a name="l00264"></a>00264 
<a name="l00265"></a>00265 };
<a name="l00266"></a>00266 
<a name="l00267"></a>00267 <span class="preprocessor">#endif //__SVSReader__ conditional include</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Mon Apr 21 2014 10:04:35 for klImageCore by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
