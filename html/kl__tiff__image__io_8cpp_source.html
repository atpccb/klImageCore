<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>klImageCore: kl_tiff_image_io.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>kl_tiff_image_io.cpp</h1>  </div>
</div>
<div class="contents">
<a href="kl__tiff__image__io_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*******************************</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) &lt;2007&gt;, &lt;Bruce Campbell&gt; All rights reserved. Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met: 1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  </span>
<a name="l00003"></a>00003 <span class="comment"> * Bruce B Campbell 11 30 2012  *</span>
<a name="l00004"></a>00004 <span class="comment"> ********************************/</span>
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;string&gt;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;vector&gt;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;map&gt;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;sstream&gt;</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="kl__image__io_8h.html">kl_image_io.h</a>&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="kl__tiff__image__io_8h.html">kl_tiff_image_io.h</a>&quot;</span>
<a name="l00014"></a>00014 
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;tiffio.h&quot;</span>                 
<a name="l00017"></a><a class="code" href="kl__tiff__image__io_8h.html#abd2d22863725fc27bea3e9540745c2c4">00017</a> <span class="keywordtype">bool</span> <a class="code" href="kl__tiff__image__io_8cpp.html#abd2d22863725fc27bea3e9540745c2c4">read_tiff</a> (<span class="keyword">const</span> <span class="keywordtype">char</span>* filename,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structkl_j_p_e_g_turbo_image_struct.html#a0ff7ae3fc9908571ae10d13bf6c2563c">width</a>,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structkl_j_p_e_g_turbo_image_struct.html#ac556d51fee27105e9a5fbaaa7db40e9c">height</a>,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structkl_j_p_e_g_turbo_image_struct.html#afe38af42756dd94630ef9bb898c0257e">bands</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * inputbuf)
<a name="l00018"></a>00018 {
<a name="l00019"></a>00019     <span class="comment">/*FILE * tifffile;</span>
<a name="l00020"></a>00020 <span class="comment"></span>
<a name="l00021"></a>00021 <span class="comment">    tifffile = fopen (filename, &quot;rb&quot;);</span>
<a name="l00022"></a>00022 <span class="comment"></span>
<a name="l00023"></a>00023 <span class="comment">    if (!tifffile) </span>
<a name="l00024"></a>00024 <span class="comment">    {</span>
<a name="l00025"></a>00025 <span class="comment">    std::stringstream ANSI_INFO_ss (std::stringstream::in | std::stringstream::out );</span>
<a name="l00026"></a>00026 <span class="comment">    ANSI_INFO_ss&lt;&lt;&quot;ANSI COMPILE INFO: &quot; &lt;&lt;__DATE__&lt;&lt;&quot;     &quot;&lt;&lt;__TIME__&lt;&lt;&quot;   &quot;&lt;&lt;__FILE__&lt;&lt;&quot;   &quot;&lt;&lt;__LINE__&lt;&lt;&quot;       &quot;&lt;&lt;std::endl;</span>
<a name="l00027"></a>00027 <span class="comment">    std::string err = ANSI_INFO_ss.str();</span>
<a name="l00028"></a>00028 <span class="comment">    err+=&quot;bool read_tiff(const char* filename,unsigned int width,unsigned int height,unsigned int bands, unsigned char * inputbuf) :  Could not open file for reading tiff image data&quot;;</span>
<a name="l00029"></a>00029 <span class="comment">    throw err;</span>
<a name="l00030"></a>00030 <span class="comment">    }*/</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032     TIFF* tif = TIFFOpen(filename, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l00033"></a>00033     <span class="keywordflow">if</span> (tif) 
<a name="l00034"></a>00034     {
<a name="l00035"></a>00035         uint32 imagelength;
<a name="l00036"></a>00036         tsize_t scanline;
<a name="l00037"></a>00037         uint32 imageheight;
<a name="l00038"></a>00038         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* buf;
<a name="l00039"></a>00039         uint32 row;
<a name="l00040"></a>00040         uint32 col;
<a name="l00041"></a>00041 
<a name="l00042"></a>00042         TIFFGetField(tif, TIFFTAG_IMAGELENGTH, &amp;imagelength);
<a name="l00043"></a>00043         scanline = TIFFScanlineSize(tif);
<a name="l00044"></a>00044         imageheight = scanline /3 ;
<a name="l00045"></a>00045         buf =(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*) _TIFFmalloc(scanline);
<a name="l00046"></a>00046 
<a name="l00047"></a>00047         <span class="keywordflow">for</span> (row = 0; row &lt; imagelength; row++)
<a name="l00048"></a>00048         {
<a name="l00049"></a>00049             TIFFReadScanline(tif, buf, row);
<a name="l00050"></a>00050             <span class="keywordflow">for</span> (col = 0; col &lt; scanline; col++)
<a name="l00051"></a>00051                     printf(<span class="stringliteral">&quot;%d &quot;</span>, buf[col]);
<a name="l00052"></a>00052 
<a name="l00053"></a>00053             printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00054"></a>00054         }
<a name="l00055"></a>00055         _TIFFfree(buf);
<a name="l00056"></a>00056         TIFFClose(tif);
<a name="l00057"></a>00057     }
<a name="l00058"></a>00058     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 }
<a name="l00061"></a>00061               
<a name="l00062"></a><a class="code" href="kl__tiff__image__io_8h.html#ada73fb96ba04cb6b2479ca56c0eea09a">00062</a> <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> <a class="code" href="kl__tiff__image__io_8cpp.html#abd2d22863725fc27bea3e9540745c2c4">read_tiff</a> (<span class="keyword">const</span> <span class="keywordtype">char</span>* filename)
<a name="l00063"></a>00063 {   
<a name="l00064"></a>00064     TIFF* tif = TIFFOpen(filename, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l00065"></a>00065     <span class="keywordflow">if</span> (tif) 
<a name="l00066"></a>00066     {
<a name="l00067"></a>00067         tsize_t scanline;
<a name="l00068"></a>00068         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* buf;
<a name="l00069"></a>00069         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structkl_j_p_e_g_turbo_image_struct.html#a0ff7ae3fc9908571ae10d13bf6c2563c">width</a>;
<a name="l00070"></a>00070         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structkl_j_p_e_g_turbo_image_struct.html#ac556d51fee27105e9a5fbaaa7db40e9c">height</a>;
<a name="l00071"></a>00071         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bpp;
<a name="l00072"></a>00072 
<a name="l00073"></a>00073         TIFFGetField(tif, TIFFTAG_IMAGELENGTH, &amp;height);
<a name="l00074"></a>00074 
<a name="l00075"></a>00075         TIFFGetField(tif, TIFFTAG_IMAGEWIDTH,&amp;width);   
<a name="l00076"></a>00076     
<a name="l00077"></a>00077         TIFFGetField(tif,TIFFTAG_BITSPERSAMPLE,&amp;bpp);
<a name="l00078"></a>00078 
<a name="l00079"></a>00079         scanline = TIFFScanlineSize(tif);
<a name="l00080"></a>00080 
<a name="l00081"></a>00081         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> widthTemp = scanline /3 ;
<a name="l00082"></a>00082         buf =(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*) _TIFFmalloc(scanline);
<a name="l00083"></a>00083         
<a name="l00084"></a>00084         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> inbands = 3;
<a name="l00085"></a>00085         
<a name="l00086"></a>00086         <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> rbp= <span class="keyword">new</span>  <a class="code" href="classkl_packed_heap_raster_buffer.html">klPackedHeapRasterBuffer&lt;unsigned char&gt;</a>(width,height,inbands);
<a name="l00087"></a>00087         <span class="keywordtype">size_t</span> outbands=rbp-&gt;numBands();
<a name="l00088"></a>00088         <span class="keywordtype">size_t</span> outwidth =rbp-&gt;width();
<a name="l00089"></a>00089         <span class="keywordtype">size_t</span> outheight=rbp-&gt;height(); 
<a name="l00090"></a>00090         <span class="keywordtype">size_t</span> outbandStride=rbp-&gt;bandStride();
<a name="l00091"></a>00091         <span class="keywordtype">size_t</span> outxStride =rbp-&gt;xStride();
<a name="l00092"></a>00092         <span class="keywordtype">size_t</span> outyStride= rbp-&gt;yStride();
<a name="l00093"></a>00093 
<a name="l00094"></a>00094         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* outbuf=rbp-&gt;buffer();
<a name="l00095"></a>00095 
<a name="l00096"></a>00096         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> row;
<a name="l00097"></a>00097         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col;
<a name="l00098"></a>00098         <span class="keywordflow">for</span> (row = 0; row &lt; height; row++)
<a name="l00099"></a>00099         {
<a name="l00100"></a>00100             TIFFReadScanline(tif, buf, row);
<a name="l00101"></a>00101 
<a name="l00102"></a>00102             memcpy(outbuf+scanline*row ,buf, outyStride);
<a name="l00103"></a>00103 
<a name="l00104"></a>00104         }
<a name="l00105"></a>00105         _TIFFfree(buf);
<a name="l00106"></a>00106         TIFFClose(tif);
<a name="l00107"></a>00107         <span class="keywordflow">return</span> rbp;
<a name="l00108"></a>00108     }
<a name="l00109"></a>00109     <span class="keywordflow">else</span>
<a name="l00110"></a>00110     {
<a name="l00111"></a>00111         <span class="keywordflow">return</span> NULL;
<a name="l00112"></a>00112     }   
<a name="l00113"></a>00113 }
<a name="l00114"></a>00114 
<a name="l00115"></a><a class="code" href="kl__tiff__image__io_8h.html#af822b6a49d71061cd82a536d1448f4eb">00115</a> <span class="keywordtype">bool</span> <a class="code" href="kl__tiff__image__io_8cpp.html#af822b6a49d71061cd82a536d1448f4eb">query_tiff</a> (<span class="keyword">const</span> <span class="keywordtype">char</span>* filename,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> &amp;<a class="code" href="structkl_j_p_e_g_turbo_image_struct.html#a0ff7ae3fc9908571ae10d13bf6c2563c">width</a>,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> &amp;<a class="code" href="structkl_j_p_e_g_turbo_image_struct.html#ac556d51fee27105e9a5fbaaa7db40e9c">height</a>,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> &amp;<a class="code" href="structkl_j_p_e_g_turbo_image_struct.html#afe38af42756dd94630ef9bb898c0257e">bands</a>)
<a name="l00116"></a>00116 {
<a name="l00117"></a>00117     TIFF* tif = TIFFOpen(filename, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l00118"></a>00118     <span class="keywordflow">if</span> (tif) 
<a name="l00119"></a>00119     {
<a name="l00120"></a>00120         tsize_t scanline;
<a name="l00121"></a>00121         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* buf;
<a name="l00122"></a>00122         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> w;
<a name="l00123"></a>00123         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> h;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125         TIFFGetField(tif, TIFFTAG_IMAGELENGTH, &amp;width);
<a name="l00126"></a>00126         scanline = TIFFScanlineSize(tif);
<a name="l00127"></a>00127         h = scanline /3 ;
<a name="l00128"></a>00128 
<a name="l00129"></a>00129         width = w;
<a name="l00130"></a>00130         height =h;
<a name="l00131"></a>00131         bands =3;
<a name="l00132"></a>00132         TIFFClose(tif);
<a name="l00133"></a>00133         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00134"></a>00134     }
<a name="l00135"></a>00135     <span class="keywordflow">else</span>
<a name="l00136"></a>00136     {
<a name="l00137"></a>00137         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00138"></a>00138     }
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 }
<a name="l00141"></a>00141 
<a name="l00142"></a><a class="code" href="kl__tiff__image__io_8h.html#a69cf00993f28a472ff59933dce4926c3">00142</a> <span class="keywordtype">void</span> <a class="code" href="kl__tiff__image__io_8cpp.html#a69cf00993f28a472ff59933dce4926c3">writeTiffFile</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* fileName,    <a class="code" href="kl__image__buffer_8h.html#ae411c8671aea3ca24d160c5c58aafd88">klRasterBufferPointer</a> <a class="code" href="structkl_j_p_e_g_turbo_image_struct.html#a73ee2bdf378f95b34abde5022a60f95b">buffer</a>)
<a name="l00143"></a>00143 {
<a name="l00144"></a>00144     uint32 <a class="code" href="structkl_j_p_e_g_turbo_image_struct.html#a0ff7ae3fc9908571ae10d13bf6c2563c">width</a> = buffer-&gt;width();
<a name="l00145"></a>00145     uint32 <a class="code" href="structkl_j_p_e_g_turbo_image_struct.html#ac556d51fee27105e9a5fbaaa7db40e9c">height</a> = buffer-&gt;height();
<a name="l00146"></a>00146 
<a name="l00147"></a>00147     uint32 <a class="code" href="structkl_j_p_e_g_turbo_image_struct.html#afe38af42756dd94630ef9bb898c0257e">bands</a> = buffer-&gt;numBands();
<a name="l00148"></a>00148 
<a name="l00149"></a>00149     TIFF *out= TIFFOpen(fileName, <span class="stringliteral">&quot;w&quot;</span>); 
<a name="l00150"></a>00150     
<a name="l00151"></a>00151     <span class="keywordtype">int</span> sampleperpixel = bands;    
<a name="l00152"></a>00152 
<a name="l00153"></a>00153     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *image= buffer-&gt;buffer();
<a name="l00154"></a>00154         
<a name="l00155"></a>00155     TIFFSetField (out, TIFFTAG_IMAGEWIDTH, width);  <span class="comment">// set the width of the image</span>
<a name="l00156"></a>00156     TIFFSetField(out, TIFFTAG_IMAGELENGTH, height);    <span class="comment">// set the height of the image</span>
<a name="l00157"></a>00157 
<a name="l00158"></a>00158     TIFFSetField(out, TIFFTAG_SAMPLESPERPIXEL, sampleperpixel);   <span class="comment">// set number of channels per pixel</span>
<a name="l00159"></a>00159     TIFFSetField(out, TIFFTAG_BITSPERSAMPLE, 8);    <span class="comment">// set the size of the channels</span>
<a name="l00160"></a>00160 
<a name="l00161"></a>00161     <span class="comment">//TIFFSetField(out, TIFFTAG_ORIENTATION, ORIENTATION_TOPLEFT);    // set the origin of the image.</span>
<a name="l00162"></a>00162     TIFFSetField(out, TIFFTAG_PLANARCONFIG, PLANARCONFIG_CONTIG);
<a name="l00163"></a>00163     TIFFSetField(out, TIFFTAG_PHOTOMETRIC, PHOTOMETRIC_RGB); 
<a name="l00164"></a>00164     
<a name="l00165"></a>00165     tsize_t linebytes = sampleperpixel * width;     <span class="comment">// length in memory of one row of pixel in the image. </span>
<a name="l00166"></a>00166 
<a name="l00167"></a>00167     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf = NULL;        <span class="comment">// buffer used to store the row of pixel information for writing to file</span>
<a name="l00168"></a>00168 
<a name="l00169"></a>00169     <span class="comment">//    Allocating memory to store the pixels of current row</span>
<a name="l00170"></a>00170     <span class="keywordflow">if</span> (TIFFScanlineSize(out)==linebytes)
<a name="l00171"></a>00171         buf =(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_TIFFmalloc(linebytes);
<a name="l00172"></a>00172     <span class="keywordflow">else</span>
<a name="l00173"></a>00173         buf = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)_TIFFmalloc(TIFFScanlineSize(out));
<a name="l00174"></a>00174 
<a name="l00175"></a>00175     <span class="comment">// We set the strip size of the file to be size of one row of pixels</span>
<a name="l00176"></a>00176     TIFFSetField(out, TIFFTAG_ROWSPERSTRIP, TIFFDefaultStripSize(out, width*sampleperpixel));
<a name="l00177"></a>00177 
<a name="l00178"></a>00178     <span class="comment">//Now writing image to the file one strip at a time</span>
<a name="l00179"></a>00179     <span class="keywordflow">for</span> (uint32 row = 0; row &lt; height; row++)
<a name="l00180"></a>00180     {
<a name="l00181"></a>00181         
<a name="l00182"></a>00182         memcpy(buf, &amp;image[(row)*linebytes], linebytes);    
<a name="l00183"></a>00183         <span class="keywordflow">if</span> (TIFFWriteScanline(out, buf, row, 0) &lt; 0)
<a name="l00184"></a>00184             <span class="keywordflow">break</span>;
<a name="l00185"></a>00185     }
<a name="l00186"></a>00186     
<a name="l00187"></a>00187     (void) TIFFClose(out); 
<a name="l00188"></a>00188     <span class="keywordflow">if</span> (buf)
<a name="l00189"></a>00189         _TIFFfree(buf);
<a name="l00190"></a>00190 
<a name="l00191"></a>00191 
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 
<a name="l00199"></a>00199 
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Mon Apr 21 2014 10:04:36 for klImageCore by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
